<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StatDeck</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='black'/><circle cx='50' cy='50' r='32' fill='white'/><!-- Left stitch curve --><path d='M30 30 C20 45, 20 55, 30 70' stroke='red' stroke-width='3' fill='none'/><!-- Right stitch curve --><path d='M70 30 C80 45, 80 55, 70 70' stroke='red' stroke-width='3' fill='none'/><!-- Stitch lines left --><line x1='28' y1='38' x2='32' y2='42' stroke='red' stroke-width='2'/><line x1='26' y1='50' x2='30' y2='54' stroke='red' stroke-width='2'/><line x1='28' y1='62' x2='32' y2='66' stroke='red' stroke-width='2'/><!-- Stitch lines right --><line x1='68' y1='38' x2='72' y2='42' stroke='red' stroke-width='2'/><line x1='70' y1='50' x2='74' y2='54' stroke='red' stroke-width='2'/><line x1='68' y1='62' x2='72' y2='66' stroke='red' stroke-width='2'/></svg>" />
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='black'/><circle cx='50' cy='50' r='32' fill='white'/><!-- Left stitch curve --><path d='M30 30 C20 45, 20 55, 30 70' stroke='red' stroke-width='3' fill='none'/><!-- Right stitch curve --><path d='M70 30 C80 45, 80 55, 70 70' stroke='red' stroke-width='3' fill='none'/><!-- Stitch lines left --><line x1='28' y1='38' x2='32' y2='42' stroke='red' stroke-width='2'/><line x1='26' y1='50' x2='30' y2='54' stroke='red' stroke-width='2'/><line x1='28' y1='62' x2='32' y2='66' stroke='red' stroke-width='2'/><!-- Stitch lines right --><line x1='68' y1='38' x2='72' y2='42' stroke='red' stroke-width='2'/><line x1='70' y1='50' x2='74' y2='54' stroke='red' stroke-width='2'/><line x1='68' y1='62' x2='72' y2='66' stroke='red' stroke-width='2'/></svg>" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript" src="//wcs.pstatic.net/wcslog.js"></script>
<script type="text/javascript">
if(!wcs_add) var wcs_add = {};
wcs_add["wa"] = "32fb5ee3ee4300";
if(window.wcs) {
wcs_do();
}
</script>

<style>
*{box-sizing:border-box}
body{
 margin:0;
 font-family:'Inter',sans-serif;
 background:#000000;
 color:#f5f5f5;
 position:relative;
}
</style>
<style>
.quote-header{
 margin-bottom:14px;
 display:flex;
 justify-content:space-between;
 align-items:flex-end;
 gap:12px;
 padding-bottom:12px;
 border-bottom:1px solid #1f1f1f;
}

.quote-header h2{
 margin:0;
 font-size:19px;
 font-weight:800;
 color:#f4f4f4;
 letter-spacing:.2px;
}

.quote-header p{
 font-size:11px;
 color:#7c7c7c;
 margin-top:5px;
 line-height:1.4;
}

.quote-count{
 padding:7px 11px;
 border-radius:10px;
 border:1px solid #2d2d2d;
 background:#121212;
 font-size:10px;
 letter-spacing:1.3px;
 color:#c9c9c9;
 white-space:nowrap;
}

.mental-prompt-row{
 display:flex;
 flex-wrap:wrap;
 gap:8px;
 margin:2px 0 8px;
}

.mental-prompt{
 background:#151515;
 border:1px solid #262626;
 border-radius:999px;
 padding:6px 10px;
 font-size:10px;
 color:#8f8f8f;
 line-height:1.2;
}

.quote-input-card{
 background:
 linear-gradient(145deg,#101010,#141414),
 repeating-linear-gradient(
   90deg,
   rgba(255,255,255,.015),
   rgba(255,255,255,.015) 1px,
   transparent 1px,
   transparent 12px
 );
 border:1px solid #242424;
 border-radius:16px;
 padding:14px;
 margin-bottom:20px;
 display:flex;
 flex-direction:column;
 gap:10px;
}

.quote-input-footer{
 display:flex;
 justify-content:space-between;
 align-items:flex-end;
 gap:10px;
}

.quote-tip{
 font-size:10px;
 color:#6f6f6f;
 letter-spacing:.1px;
}

.quote-input-card button{
 width:auto;
 min-width:108px;
 margin-top:0;
 background:#e7e7e7;
 color:#121212;
 font-size:12px;
 font-weight:700;
 border:1px solid #3a3a3a;
 box-shadow:none;
}

.quote-grid.modern{
 display:grid;
 gap:10px;
}

.quote-card{
 --entry-accent:#c1121f;
 background:#101010;
 border-radius:13px;
 padding:14px;
 position:relative;
 border:1px solid #232323;
 transition:all 0.2s ease;
 overflow:visible;
}

.quote-card:hover{
 transform:translateY(-2px);
 border-color:#333;
}

.quote-card::after{
 content:"";
 position:absolute;
 top:8px;
 left:0;
 width:3px;
 height:calc(100% - 16px);
 border-radius:4px;
 background:var(--entry-accent);
 opacity:.9;
}

.quote-text{
 font-size:14px;
 font-weight:600;
 line-height:1.65;
 letter-spacing:0.05px;
 color:#f1f1f1;
 padding-left:10px;
}

.quote-meta{
 margin-top:8px;
 font-size:10px;
 color:#747474;
 display:flex;
 justify-content:space-between;
 align-items:center;
}

.quote-meta.top{
 font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
 letter-spacing:.6px;
}

.quote-delete{
 font-size:11px;
 color:#9a9a9a;
 cursor:pointer;
 padding:3px 7px;
 border-radius:8px;
 border:1px solid #2f2f2f;
 background:#171717;
}

.quote-delete:hover{
 color:#ffffff;
 border-color:#454545;
}

.premium-note{
  background:linear-gradient(145deg,#0f0f0f,#151515);
  border:1px solid rgba(255,255,255,0.05);
  border-radius:20px;
  padding:20px;
}

.note-label{
  font-size:10px;
  letter-spacing:1.8px;
  color:#868686;
  margin-bottom:2px;
}

.note-area{
  min-height:140px;
  resize:none;
  padding:7px 12px 10px;
  border-radius:10px;
  border:1px solid #282828;
  background:
    repeating-linear-gradient(
      to bottom,
      #0f0f0f 0px,
      #0f0f0f 31px,
      #242424 31px,
      #242424 32px
    );
  color:#efefef;
  font-size:13px;
  line-height:32px;
  font-family:'Inter',sans-serif;
  background-position:0 6px;
}

.note-area::placeholder{
 color:#5f5f5f;
}

.quote-empty{
 border:1px dashed #2b2b2b;
 border-radius:12px;
 padding:22px 14px;
 text-align:center;
 color:#6d6d6d;
 font-size:12px;
 background:#101010;
}

.note-area:focus{
  outline:none;
  border:1px solid #454545;
  box-shadow:none;
}

.quote-card{
  animation:fadeInCard 0.25s ease forwards;
}

@keyframes fadeInCard{
  from{opacity:0; transform:translateY(12px);}
  to{opacity:1; transform:translateY(0);}
}

@media (max-width: 460px){
 .quote-header{
  flex-direction:column;
  align-items:flex-start;
 }
 .mental-prompt-row{
  width:100%;
 }
 .quote-input-footer{
  flex-direction:column;
  align-items:flex-start;
 }
 .quote-input-card button{
  width:100%;
 }
}
</style>
<style>
.day-record{
 margin-top:16px;
 opacity:0;
 transform:translateY(20px);
 transition:all 0.35s cubic-bezier(0.2,0.8,0.2,1);
}

.day-record.active{
 opacity:1;
 transform:translateY(0);
}

.day-games{
 margin-top:14px;
 display:grid;
 gap:8px;
}

.day-game-item{
 border:1px solid #292929;
 border-radius:12px;
 background:#141414;
 padding:10px;
}

.day-game-top{
 display:flex;
 justify-content:space-between;
 align-items:center;
 font-size:11px;
 color:#a8a8a8;
 margin-bottom:8px;
}

.day-game-name{
 font-size:12px;
 color:#e5e5e5;
 font-weight:600;
 margin-bottom:6px;
}

.day-game-line{
 font-size:12px;
 color:#d2d2d2;
}

.day-game-actions{
 margin-top:10px;
 display:flex;
 gap:8px;
}

.mini-btn{
 width:auto;
 min-width:64px;
 margin-top:0;
 padding:7px 10px;
 border-radius:8px;
 font-size:11px;
 font-weight:700;
 border:1px solid #363636;
 background:#1a1a1a;
 color:#f3f3f3;
}

.mini-btn.danger{
 border-color:#5a2a2a;
 background:#2a1313;
 color:#ffcdcd;
}

.profile-card{
 background:linear-gradient(145deg,#0f0f0f,#161616);
 border:1px solid #252525;
}

.profile-subtabs{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:8px;
 margin-bottom:12px;
}

.profile-subtab-btn{
 margin-top:0;
 padding:9px 10px;
 border-radius:10px;
 border:1px solid #2e2e2e;
 background:#141414;
 color:#cfcfcf;
 font-size:12px;
 font-weight:700;
}

.profile-subtab-btn.active{
 background:linear-gradient(145deg,#1d1d1d,#121212);
 color:#ffffff;
 border-color:#4a4a4a;
}

.profile-panel.hidden{
 display:none;
}

.profile-top{
 display:flex;
 gap:14px;
 align-items:center;
 margin-bottom:14px;
}

.avatar-wrap{
 width:78px;
 height:78px;
 border-radius:50%;
 border:2px solid #2f2f2f;
 overflow:hidden;
 background:#111;
 flex-shrink:0;
}

.avatar-wrap img{
 width:100%;
 height:100%;
 object-fit:cover;
 display:block;
}

.profile-meta h3{
 margin:0;
 font-size:16px;
 color:#f4f4f4;
}

.profile-meta p{
 margin:6px 0 0;
 font-size:12px;
 color:#969696;
 line-height:1.5;
}

.profile-season-note{
 margin-top:8px;
 font-size:10px;
 color:#777;
 letter-spacing:.4px;
}

.profile-streak{
 margin-top:8px;
 font-size:11px;
 color:#b9c4d6;
}

.profile-badge-head{
 margin-top:8px;
 display:flex;
 align-items:center;
 justify-content:space-between;
 gap:8px;
}

.profile-badge-title{
 font-size:11px;
 color:#9eabc0;
 letter-spacing:.35px;
}

.profile-badge-count{
 font-size:10px;
 color:#cad4e4;
 border:1px solid #333d4d;
 border-radius:999px;
 padding:3px 7px;
}

.badge-guide-btn{
 margin-top:0;
 width:auto;
 padding:6px 8px;
 border-radius:8px;
 border:1px solid #333d4d;
 background:#151c26;
 color:#d3dded;
 font-size:10px;
 font-weight:700;
}

.profile-badges{
 margin-top:8px;
 display:flex;
 flex-wrap:wrap;
 gap:6px;
}

.badge-chip{
 padding:5px 8px;
 border-radius:999px;
 border:1px solid #344055;
 background:linear-gradient(160deg,#182233,#111923);
 color:#dfe9fb;
 font-size:10px;
 font-weight:700;
 letter-spacing:.2px;
}

.profile-stat-grid{
 margin-top:12px;
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:8px;
}

.profile-stat{
 border:1px solid #2b2b2b;
 border-radius:12px;
 background:#131313;
 padding:10px 8px;
 text-align:center;
}

.profile-stat .label{
 font-size:10px;
 color:#8f8f8f;
 letter-spacing:.6px;
}

.profile-stat .value{
 margin-top:6px;
 font-size:18px;
 font-weight:800;
 color:#f3f3f3;
}

.profile-ai-entry{
 margin-top:10px;
 border:1px solid rgba(255,255,255,0.14);
 border-radius:16px;
 background:
  radial-gradient(circle at 10% 20%, rgba(193,18,31,0.22), transparent 42%),
  radial-gradient(circle at 88% 78%, rgba(0,87,183,0.22), transparent 44%),
  linear-gradient(120deg,#111111 0%,#1a1a1a 52%,#101010 100%);
 color:#f8f8f8;
 position:relative;
 overflow:hidden;
 text-align:left;
 padding:15px 16px;
 box-shadow:
  inset 0 1px 0 rgba(255,255,255,0.08),
  0 10px 20px rgba(0,0,0,0.35);
 transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
}

.profile-ai-entry::after{
 content:"";
 position:absolute;
 inset:0;
 pointer-events:none;
 background:linear-gradient(135deg,rgba(255,255,255,0.08),transparent 48%);
}

.profile-ai-entry:hover{
 transform:translateY(-2px);
 border-color:rgba(255,255,255,0.26);
 box-shadow:
  inset 0 1px 0 rgba(255,255,255,0.14),
  0 12px 24px rgba(0,0,0,0.46);
}

.profile-ai-title{
 font-size:13px;
 font-weight:800;
 letter-spacing:.4px;
 color:#f1f1f1;
 text-shadow:none;
 display:block;
}

.profile-ai-sub{
 margin-top:4px;
 font-size:11px;
 color:#b7b7b7;
 display:block;
}

.profile-editor{
 margin-top:10px;
 padding:12px;
 border:1px solid #292929;
 border-radius:14px;
 background:#111;
}

.profile-editor.hidden{
 display:none;
}

.profile-label{
 font-size:11px;
 color:#9a9a9a;
 margin:10px 0 6px;
 letter-spacing:.4px;
}

.profile-input,
.profile-textarea{
 width:100%;
 border-radius:10px;
 border:1px solid #2c2c2c;
 background:#121212;
 color:#f1f1f1;
 padding:10px;
 font-size:13px;
}

.profile-textarea{
 min-height:84px;
 resize:vertical;
}

.profile-upload-row{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:8px;
 margin-top:10px;
}

.upload-btn{
 width:100%;
 margin-top:0;
 background:#1b1b1b;
 color:#ececec;
 border:1px solid #343434;
 font-size:12px;
}

.profile-grid{
 margin-top:10px;
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:8px;
}

.profile-photo{
 position:relative;
 width:100%;
 aspect-ratio:1/1;
 border-radius:10px;
 overflow:hidden;
 border:1px solid #303030;
 background:#101010;
}

.profile-photo img{
 width:100%;
 height:100%;
 object-fit:cover;
 display:block;
}

.photo-remove{
 position:absolute;
 top:6px;
 right:6px;
 width:22px;
 height:22px;
 min-width:22px;
 margin-top:0;
 padding:0;
 border:none;
 border-radius:50%;
 background:rgba(0,0,0,0.65);
 color:#fff;
 font-size:12px;
 display:flex;
 align-items:center;
 justify-content:center;
}

.profile-actions{
 margin-top:14px;
 display:grid;
 gap:8px;
}

.profile-actions button{
 margin-top:0;
}

.profile-actions .danger{
 background:#2a1313;
 color:#ffd4d4;
 border:1px solid #5a2a2a;
}

.record-manage-list{
 margin-top:10px;
 display:grid;
 gap:8px;
}

.record-item{
 border:1px solid #2a2a2a;
 border-radius:12px;
 background:#131313;
 padding:10px;
}

.record-item-top{
 display:flex;
 justify-content:space-between;
 align-items:center;
 font-size:11px;
 color:#9f9f9f;
 margin-bottom:6px;
}

.record-item-title{
 font-size:12px;
 color:#ededed;
 font-weight:600;
 margin-bottom:4px;
}

.record-item-line{
 font-size:12px;
 color:#cdcdcd;
}

.record-item-actions{
 display:flex;
 gap:8px;
 margin-top:8px;
}
</style>
<style>
body::before{
 content:"";
 position:fixed;
 inset:0;
 pointer-events:none;
 opacity:0.04;
 z-index:0;
 background-image:
   radial-gradient(circle at 25% 25%, #ffffff 1px, transparent 1px),
   radial-gradient(circle at 75% 75%, #ffffff 1px, transparent 1px);
 background-size:3px 3px;
}
.container, .header, .tab-bar, #splash{
 position:relative;
 z-index:1;
}
.header{
 padding:16px;
 text-align:center;
 background:rgba(15,15,15,0.7);
 backdrop-filter:blur(20px);
 -webkit-backdrop-filter:blur(20px);
 border-bottom:1px solid rgba(255,255,255,0.05);
}
.container{padding:16px;max-width:520px;margin:auto;padding-bottom:100px}
.card{background:#111;padding:16px;border-radius:18px;margin-bottom:16px;border:1px solid #222}
input,select{width:100%;padding:10px;margin-bottom:8px;border-radius:10px;border:1px solid #222;background:#1a1a1a;color:white}
button{width:100%;padding:12px;border:none;border-radius:12px;background:#ffffff;color:#000;font-weight:700;margin-top:8px}
.pitch-speed-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.pitch-speed-grid input{margin-bottom:0}
.input-subtitle{font-size:11px;color:#9aa0aa;margin:4px 0 8px}
.entry-card{
 background:linear-gradient(150deg,#101214,#161a20);
 border-color:#2a313c;
}
.entry-top{
 margin-bottom:10px;
}
.entry-top h3{
 margin:0;
 font-size:15px;
 color:#edf2fb;
}
.entry-top p{
 margin:6px 0 0;
 font-size:11px;
 color:#9ca6b6;
}
.entry-core-grid{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:8px;
 margin-bottom:8px;
}
.entry-core-grid input,
.entry-core-grid select{
 margin-bottom:0;
}
.entry-role-picker{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:8px;
 margin:8px 0 10px;
}
.entry-role-btn{
 margin-top:0;
 padding:10px 8px;
 border-radius:10px;
 border:1px solid #303847;
 background:#131a24;
 color:#ccd7e8;
 font-size:12px;
 font-weight:700;
}
.entry-role-btn.active{
 background:linear-gradient(160deg,#e7eefc,#d8e0ef);
 border-color:#c6d2e8;
 color:#111722;
}
.entry-group{
 border:1px solid #2a303a;
 border-radius:12px;
 background:#12161c;
 padding:10px;
 margin-bottom:8px;
}
.entry-group-title{
 font-size:11px;
 color:#97a2b3;
 margin-bottom:8px;
 letter-spacing:.2px;
}
.entry-mini-grid{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:8px;
}
.entry-mini-grid input{
 margin-bottom:0;
}
.entry-collapse-btn{
 margin-top:0;
 border:1px solid #313845;
 background:#161c25;
 color:#d2dceb;
 font-size:11px;
 padding:9px 10px;
}
.entry-advanced{
 margin-top:8px;
}
@media (max-width: 460px){
 .entry-core-grid{
  grid-template-columns:1fr;
 }
 .entry-mini-grid{
  grid-template-columns:1fr 1fr;
 }
}
.section-hero{
 margin-bottom:12px;
 border:1px solid #2a2f38;
 border-radius:16px;
 padding:12px 14px;
 background:linear-gradient(130deg,#111822,#141b29);
 box-shadow:inset 0 1px 0 rgba(255,255,255,0.04);
}
.section-hero-title{
 margin:0;
 font-size:13px;
 letter-spacing:.8px;
 color:#e7edf8;
 font-weight:800;
}
.section-hero-sub{
 margin-top:4px;
 font-size:11px;
 color:#98a4b8;
}
.input-hero{
 border-color:#29384f;
 background:
  radial-gradient(circle at 10% 10%, rgba(193,18,31,0.18), transparent 36%),
  radial-gradient(circle at 90% 90%, rgba(0,87,183,0.18), transparent 38%),
  linear-gradient(130deg,#111926,#151f30);
}
.calendar-hero{
 border-color:#2c3440;
 background:
  radial-gradient(circle at 88% 12%, rgba(99,194,255,0.18), transparent 34%),
  linear-gradient(130deg,#101822,#171f2a);
}
.mental-hero{
 border-color:#3a2d2d;
 background:
  radial-gradient(circle at 12% 12%, rgba(193,18,31,0.2), transparent 36%),
  radial-gradient(circle at 85% 75%, rgba(0,87,183,0.16), transparent 38%),
  linear-gradient(130deg,#171313,#1a1a1d);
}
.stats-hero{
 border-color:#2e3441;
 background:
  radial-gradient(circle at 18% 14%, rgba(0,87,183,0.17), transparent 34%),
  radial-gradient(circle at 86% 78%, rgba(193,18,31,0.13), transparent 36%),
  linear-gradient(130deg,#10161f,#171d29);
}
#inputSection .card{
 background:linear-gradient(150deg,#101214,#15181c);
 border-color:#27313d;
}
#inputSection .card h3{
 color:#e9eef9;
 letter-spacing:.4px;
}
#inputSection input:focus,
#inputSection select:focus{
 outline:none;
 border-color:#4f6788;
 box-shadow:0 0 0 2px rgba(79,103,136,0.18);
}
#calendarSection .card{
 background:#111;
 border-color:#222;
}
#statsSection .card{
 background:#111;
 border-color:#222;
}
#statsSection .card h3{
 color:#e5ecf8;
 letter-spacing:.35px;
}
#quoteSection .quote-input-card{
 border-color:#3a2c32;
 background:
  radial-gradient(circle at 12% 10%, rgba(193,18,31,0.12), transparent 26%),
  radial-gradient(circle at 88% 90%, rgba(0,87,183,0.1), transparent 30%),
  linear-gradient(145deg,#101011,#161518),
  repeating-linear-gradient(
    90deg,
    rgba(255,255,255,.015),
    rgba(255,255,255,.015) 1px,
    transparent 1px,
    transparent 12px
  );
}
#quoteSection .quote-header{
 border-bottom-color:#2a2226;
}
.stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.stat-box{background:#1a1a1a;padding:12px;border-radius:12px;text-align:center}
.stat-grid.pitcher-template{
 grid-template-columns:repeat(2,1fr);
}
.mode-toggle{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:8px;
 margin:8px 0 12px;
}

.mode-btn{
 width:100%;
 margin-top:0;
 padding:10px 8px;
 border-radius:10px;
 border:1px solid #303030;
 background:#161616;
 color:#cfcfcf;
 font-size:12px;
 font-weight:700;
}

.mode-btn.active{
 background:#efefef;
 color:#111;
 border-color:#efefef;
}

.hidden{
 display:none !important;
}

.weekly-report{
 background:linear-gradient(145deg,#101010,#171717);
 border:1px solid #262626;
 border-radius:14px;
 padding:14px;
}

.weekly-report h4{
 margin:0 0 8px;
 font-size:13px;
 color:#f0f0f0;
}

.weekly-report p{
 margin:0;
 font-size:12px;
 color:#b5b5b5;
 line-height:1.6;
}
.stat-box.highlight{
  border:2px solid #ffffff;
  box-shadow:0 0 18px rgba(255,255,255,0.25);
}

.stat-box.ops-elite{
  border:2px solid #c1121f;
  box-shadow:0 0 18px rgba(193,18,31,0.35);
}

.stat-box.ops-legend{
  border:2px solid #ff3b3b;
  box-shadow:0 0 28px rgba(255,59,59,0.55);
  transform:scale(1.03);
}

.stat-box.avg-premium{
  border:2px solid #ffffff;
  box-shadow:0 0 28px rgba(255,255,255,0.55);
  background:linear-gradient(145deg,#1a1a1a,#222);
  transform:scale(1.03);
}
.calendar.modern{
 display:grid;
 grid-template-columns:repeat(7,1fr);
 gap:8px;
 margin-top:14px;
 background:linear-gradient(145deg,#0f0f0f,#141414);
 border:1px solid #232323;
 border-radius:16px;
 padding:10px;
}
.weekday{
 font-size:10px;
 color:#8d8d8d;
 text-align:center;
 padding:4px 0 8px;
 font-weight:700;
 letter-spacing:.4px;
}
.day{
 min-height:46px;
 padding:10px 0;
 border-radius:12px;
 background:#111;
 font-weight:600;
 font-size:12px;
 border:1px solid #232323;
 transition:0.2s ease;
 display:flex;
 align-items:center;
 justify-content:center;
 position:relative;
}
.day:hover{
 background:#171717;
 border-color:#3a3a3a;
}
.day.has{
 background:linear-gradient(145deg,#151515,#1a1a1a);
 border:1px solid #313131;
}
.day.selected{
 border:1px solid #ffffff;
 background:#1e1e1e;
 box-shadow:0 0 0 2px rgba(255,255,255,0.08);
}

.day.win{
 border-color:#bfc4c9;
}

.day.heat-mid::after,
.day.heat-high::after{
 content:"";
 position:absolute;
 bottom:5px;
 width:6px;
 height:6px;
 border-radius:50%;
}

.day.heat-mid::after{
 background:#8ecae6;
}

.day.heat-high::after{
 background:#e63946;
 box-shadow:0 0 10px rgba(230,57,70,.55);
}

.day-empty{
 min-height:46px;
 border-radius:12px;
 background:transparent;
 border:1px dashed rgba(255,255,255,0.04);
}

.calendar-toolbar{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:8px;
}

.calendar-title{
 font-size:14px;
 font-weight:700;
 color:#ececec;
}

.calendar-nav{
 display:flex;
 gap:8px;
}

.calendar-nav-btn{
 width:34px;
 height:34px;
 min-width:34px;
 margin-top:0;
 padding:0;
 border-radius:10px;
 border:1px solid #323232;
 background:#161616;
 color:#f2f2f2;
 font-size:14px;
 font-weight:700;
 display:flex;
 align-items:center;
 justify-content:center;
 cursor:pointer;
 transition:.2s ease;
}

.calendar-nav-btn:hover{
 background:#1f1f1f;
 border-color:#4a4a4a;
}

.tab-bar{
 position:fixed;
 bottom:0;
 left:0;
 right:0;
 height:70px;
 background:rgba(20,20,20,0.75);
 backdrop-filter:blur(20px);
 -webkit-backdrop-filter:blur(20px);
 border-top:1px solid rgba(255,255,255,0.05);
 display:flex;
 justify-content:space-around;
 align-items:center;
 z-index:100;
}

.tab{
 display:flex;
 flex-direction:column;
 align-items:center;
 justify-content:center;
 gap:4px;
 font-size:11px;
 color:#777;
 cursor:pointer;
 transition:all 0.25s ease;
}

.tab.active{
 color:#ffffff;
 transform:translateY(-6px);
}

.tab.active svg{
 transform:scale(1.05);
 transition:transform 0.25s ease;
}

.section{
 display:none;
 opacity:0;
 transform:translateY(10px);
 transition:opacity 0.25s ease, transform 0.25s ease;
}

.section.active{
 display:block;
 opacity:1;
 transform:translateY(0);
}

/* Splash Screen */
#splash{
 position:fixed;
 inset:0;
 background:#000;
 display:flex;
 align-items:center;
 justify-content:center;
 z-index:9999;
 transition:opacity 0.6s ease, visibility 0.6s ease;
}

#splash.hide{
 opacity:0;
 visibility:hidden;
}

.splash-content{
 text-align:center;
 animation:fadeInUp 1s ease forwards;
}

.logo-text{
 font-size:32px;
 font-weight:800;
 letter-spacing:2px;
 background:linear-gradient(90deg,#ffffff,#999999);
 -webkit-background-clip:text;
 -webkit-text-fill-color:transparent;
 text-shadow:0 0 18px rgba(255,255,255,0.15);
}
/* Splash icon animation */
.splash-icon{
 animation:spinBall 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}

@keyframes spinBall{
 0%{transform:rotate(0deg);} 
 60%{transform:rotate(720deg);} 
 100%{transform:rotate(900deg);} 
}

.logo-sub{
 font-size:12px;
 color:#888;
 margin-top:8px;
 letter-spacing:1px;
}

@keyframes fadeInUp{
 from{opacity:0; transform:translateY(20px);} 
 to{opacity:1; transform:translateY(0);} 
}

/* Header logo styling upgrade */
.header h1{
 background:linear-gradient(90deg,#ffffff,#aaaaaa);
 -webkit-background-clip:text;
 -webkit-text-fill-color:transparent;
 font-weight:800;
 letter-spacing:1.5px;
}

.note-modal{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,0.85);
 backdrop-filter:blur(12px);
 display:flex;
 justify-content:center;
 align-items:center;
 opacity:0;
 pointer-events:none;
 transition:0.3s ease;
 z-index:2000;
}

.note-modal.active{
 opacity:1;
 pointer-events:auto;
}

.note-modal-content{
 width:92%;
 max-width:560px;
 background:linear-gradient(145deg,#0e0e0e,#151515);
 border-radius:28px;
 padding:36px 30px;
 animation:modalUp 0.35s ease;
 box-shadow:0 40px 80px rgba(0,0,0,0.75);
}

.premium-modal{
 position:relative;
}

@keyframes modalUp{
 from{transform:translateY(25px);opacity:0;}
 to{transform:translateY(0);opacity:1;}
}

.modal-top{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:28px;
}

.modal-label{
 font-size:11px;
 letter-spacing:3px;
 color:#888;
}

.modal-close{
 width:36px;
 height:36px;
 min-width:36px;
 padding:0;
 background:none;
 border:1px solid #2e2e2e;
 border-radius:10px;
 color:#fff;
 font-size:24px;
 line-height:1;
 cursor:pointer;
 display:flex;
 align-items:center;
 justify-content:center;
 transition:0.2s ease;
}

.modal-close:hover{
 transform:scale(1.06);
 border-color:#4a4a4a;
 background:#171717;
}

.premium-text{
 font-size:18px;
 line-height:33px;
 letter-spacing:0.3px;
 color:#ffffff;
 min-height:140px;
 padding:14px 12px;
 border-radius:12px;
 border:1px solid #242424;
 background:
   repeating-linear-gradient(
     to bottom,
     #101010,
     #101010 32px,
     #252525 33px
   );
 white-space:pre-line;
}

.onboard{
 position:fixed;
 inset:0;
 z-index:10000;
 background:
  radial-gradient(circle at 20% 20%, rgba(193,18,31,0.18), transparent 36%),
  radial-gradient(circle at 80% 80%, rgba(0,87,183,0.16), transparent 38%),
  #060606;
 display:flex;
 align-items:center;
 justify-content:center;
 padding:18px;
}

.onboard.hidden{
 display:none;
}

.onboard-card{
 width:100%;
 max-width:520px;
 border:1px solid #262626;
 background:linear-gradient(145deg,#101010,#161616);
 border-radius:22px;
 padding:20px;
}

.onboard-step{
 display:none;
}

.onboard-step.active{
 display:block;
}

.onboard-title{
 margin:0 0 8px;
 font-size:18px;
 font-weight:800;
 color:#f4f4f4;
}

.onboard-sub{
 margin:0 0 14px;
 font-size:12px;
 color:#9d9d9d;
}

.onboard-input{
 width:100%;
 border:1px solid #2b2b2b;
 background:#121212;
 color:#f2f2f2;
 border-radius:12px;
 padding:12px;
 margin-bottom:8px;
}

.onboard-note{
 min-height:120px;
 resize:none;
 padding-top:7px;
 background:
  repeating-linear-gradient(
   to bottom,
   #111 0px,
   #111 31px,
   #292929 31px,
   #292929 32px
  );
 line-height:32px;
 background-position:0 6px;
}

.onboard-preview{
 height:120px;
 border:1px solid #2a2a2a;
 border-radius:14px;
 background:#0f0f0f;
 display:flex;
 align-items:center;
 justify-content:center;
 text-align:center;
 padding:14px;
 font-size:24px;
 font-weight:800;
 letter-spacing:.3px;
}

.onboard-fade{
 animation:onboardFade 1.1s ease;
}

@keyframes onboardFade{
 0%{opacity:0;transform:translateY(10px);}
 25%{opacity:1;transform:translateY(0);}
 75%{opacity:1;transform:translateY(0);}
 100%{opacity:0;transform:translateY(-8px);}
}

.role-grid{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:10px;
}

.role-card{
 border:1px solid #303030;
 border-radius:14px;
 background:#111;
 padding:14px;
 text-align:center;
 cursor:pointer;
 transition:.2s ease;
}

.role-card.active{
 border-color:#f2f2f2;
 box-shadow:0 0 0 1px rgba(255,255,255,0.14);
}

.role-card svg{
 width:30px;
 height:30px;
 margin-bottom:6px;
}

.role-name{
 font-size:13px;
 font-weight:700;
 color:#f3f3f3;
}

.position-field{
 position:relative;
 width:100%;
 max-width:500px;
 aspect-ratio:1/1;
 margin:8px auto 0;
 border:1px solid #2a2a2a;
 border-radius:16px;
 background:
  radial-gradient(70% 58% at 50% 82%, rgba(125,85,42,0.14), rgba(125,85,42,0) 65%),
  radial-gradient(80% 72% at 50% 22%, rgba(31,84,56,0.38), rgba(20,39,31,0.18) 70%, rgba(11,17,14,0.2) 100%),
  linear-gradient(150deg,#0f1412,#151a18 40%, #121715);
 overflow:hidden;
 box-shadow:inset 0 1px 0 rgba(255,255,255,0.04), inset 0 -20px 50px rgba(0,0,0,0.2);
}

.position-field::after{
 content:"";
 position:absolute;
 inset:12% 8% 10%;
 border-radius:24px;
 background:radial-gradient(circle at 50% 75%, rgba(230,190,130,0.1), rgba(0,0,0,0) 52%);
 pointer-events:none;
}

.pitcher-type-grid{
 display:grid;
 grid-template-columns:1fr;
 gap:12px;
}

.pitcher-role-grid{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:8px;
}

.pitcher-role-card{
 width:100%;
 margin-top:0;
 border:1px solid #2f3742;
 border-radius:13px;
 background:linear-gradient(165deg,#131923,#171f2a);
 color:#d9e3f2;
 font-size:12px;
 font-weight:800;
 padding:14px 8px;
 text-align:center;
 cursor:pointer;
 transition:.16s ease;
}

.pitcher-role-card:hover{
 border-color:#65738a;
 transform:translateY(-1px);
}

.pitcher-role-card.active{
 border-color:#c3d1e7;
 background:linear-gradient(165deg,#e1ecff,#d6e1f0);
 color:#10151c;
 box-shadow:0 8px 16px rgba(0,0,0,0.32);
}

.pitch-zone{
 position:relative;
 width:100%;
 max-width:310px;
 height:330px;
 margin:8px auto 0;
 border-radius:16px;
 border:1px solid #2f3946;
 background:linear-gradient(160deg,#101723,#141d2a);
 box-shadow:inset 0 1px 0 rgba(255,255,255,0.05);
}

.pitch-zone-core{
 position:absolute;
 left:50%;
 top:50%;
 transform:translate(-50%,-50%);
 width:172px;
 height:212px;
 display:grid;
 grid-template-columns:repeat(3, 1fr);
 grid-template-rows:repeat(3, 1fr);
 justify-items:center;
 align-items:center;
 border:2px solid #77859b;
 border-radius:8px;
 background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
 overflow:hidden;
}

.pitch-zone-core::before,
.pitch-zone-core::after{
 content:"";
 position:absolute;
 inset:0;
 pointer-events:none;
}

.pitch-zone-core::before{
 background:
  linear-gradient(to right, transparent 33.333%, rgba(152,165,184,0.28) 33.333%, rgba(152,165,184,0.28) 34.2%, transparent 34.2%, transparent 66.666%, rgba(152,165,184,0.28) 66.666%, rgba(152,165,184,0.28) 67.5%, transparent 67.5%),
  linear-gradient(to bottom, transparent 33.333%, rgba(152,165,184,0.28) 33.333%, rgba(152,165,184,0.28) 34.2%, transparent 34.2%, transparent 66.666%, rgba(152,165,184,0.28) 66.666%, rgba(152,165,184,0.28) 67.5%, transparent 67.5%);
}

.pitch-zone-core::after{
 border:1px solid rgba(255,255,255,0.05);
 border-radius:8px;
}

.pitch-zone-btn{
 position:relative;
 transform:none;
 width:auto;
 min-width:54px;
 min-height:24px;
 margin-top:0;
 display:inline-flex;
 align-items:center;
 justify-content:center;
 white-space:nowrap;
 border:none;
 border-radius:0;
 background:transparent;
 color:#b6c2d5;
 font-size:10px;
 font-weight:700;
 padding:2px 4px;
 cursor:pointer;
 letter-spacing:.15px;
 text-shadow:0 1px 4px rgba(0,0,0,0.45);
 transition:color .15s ease, text-shadow .15s ease, transform .15s ease;
}

.pitch-zone-btn.active{
 color:#eaf2ff;
 text-shadow:0 0 10px rgba(154,190,247,0.55), 0 1px 6px rgba(0,0,0,0.5);
 transform:scale(1.04);
}

.pitch-zone-btn:hover{
 color:#d3e2ff;
}

.release-grid{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:8px;
}

.release-card{
 width:100%;
 margin-top:0;
 border:1px solid #303743;
 border-radius:12px;
 background:linear-gradient(170deg,#131923,#161d27);
 color:#dae3f2;
 font-size:11px;
 font-weight:700;
 padding:10px 8px;
 text-align:center;
 cursor:pointer;
 transition:.16s ease;
}

.release-card.active{
 border-color:#c1d0e7;
 background:linear-gradient(170deg,#deebff,#d3dfef);
 color:#10141b;
}

.hand-grid{
 display:grid;
 grid-template-columns:repeat(2,1fr);
 gap:8px;
}

.pitcher-help{
 margin-top:4px;
 font-size:11px;
 color:#99a3b2;
}

.field-outline{
 position:absolute;
 inset:0;
 width:100%;
 height:100%;
}

.field-outline .line{
 fill:none;
 stroke:rgba(136,143,153,0.72);
 stroke-width:1.35;
 stroke-linecap:round;
 stroke-linejoin:round;
 filter:drop-shadow(0 1px 0 rgba(0,0,0,0.25));
}

.field-outline .line-soft{
 fill:none;
 stroke:rgba(116,124,136,0.56);
 stroke-width:1.05;
 stroke-linecap:round;
 stroke-linejoin:round;
}

.pos-btn{
 position:absolute;
 transform:translate(-50%,-50%);
 margin-top:0;
 min-width:54px;
 width:auto;
 padding:6px 8px;
 text-align:center;
 border-radius:999px;
 border:1px solid #3a3f45;
 background:linear-gradient(180deg, rgba(33,37,42,0.88), rgba(22,25,29,0.86));
 color:#eceff4;
 font-size:11px;
 font-weight:700;
 letter-spacing:.1px;
 box-shadow:0 4px 12px rgba(0,0,0,0.3);
 transition:transform .16s ease, border-color .16s ease, box-shadow .16s ease, background .16s ease;
 backdrop-filter:blur(2px);
}

.pos-btn:hover{
 transform:translate(-50%,-50%) translateY(-1px);
 border-color:#5a6472;
 box-shadow:0 8px 16px rgba(0,0,0,0.36);
}

.pos-btn.active{
 border-color:#cfd6df;
 background:linear-gradient(180deg, #e6ebf1, #d5dce6);
 color:#15181d;
 box-shadow:0 8px 20px rgba(0,0,0,0.42), 0 0 0 1px rgba(255,255,255,0.12);
}

@media (max-width: 460px){
 .position-field .pos-btn{
  min-width:48px;
  padding:5px 7px;
  font-size:10px;
 }
 .position-field .pos-btn[data-pos="2루수"]{
  left:57.2% !important;
  top:58.5% !important;
 }
 .position-field .pos-btn[data-pos="유격수"]{
  left:42.8% !important;
  top:58.5% !important;
 }
}

</style>
</head>
<body>
<div id="splash">
  <div class="splash-content">
    <svg class="splash-icon" width="60" height="60" viewBox="0 0 100 100" style="margin-bottom:16px;">
      <circle cx="50" cy="50" r="32" fill="white"/>
      <path d="M30 30 C20 45, 20 55, 30 70" stroke="#c1121f" stroke-width="3" fill="none"/>
      <path d="M70 30 C80 45, 80 55, 70 70" stroke="#c1121f" stroke-width="3" fill="none"/>
    </svg>
    <div class="logo-text">StatDeck</div>
    <div class="logo-sub">Track. Analyze. Dominate the Diamond.</div>
  </div>
</div>
<div id="onboarding" class="onboard hidden">
  <div class="onboard-card">
    <div id="onboardStep1" class="onboard-step active">
      <h3 class="onboard-title">환영합니다</h3>
      <p class="onboard-sub">처음 한 번만 설정하면 앱처럼 바로 사용할 수 있어요.</p>
      <input id="onboardName" class="onboard-input" type="text" maxlength="24" placeholder="이름">
      <textarea id="onboardBio" class="onboard-input onboard-note" maxlength="140" placeholder="소개"></textarea>
      <button onclick="onboardingToRole()">다음</button>
    </div>

    <div id="onboardStep2" class="onboard-step">
      <h3 class="onboard-title">프로필 미리보기</h3>
      <p class="onboard-sub">포지션 선택을 반영한 최종 프로필입니다.</p>
      <div id="onboardPreviewText" class="onboard-preview"></div>
      <button style="margin-top:10px" onclick="finishOnboarding()">시작하기</button>
    </div>

    <div id="onboardStepRole" class="onboard-step">
      <h3 class="onboard-title">포지션 선택</h3>
      <p class="onboard-sub">기본 포지션에 맞춰 AI 분석이 달라집니다.</p>
      <div class="role-grid">
        <div id="roleBatterCard" class="role-card" onclick="selectOnboardRole('batter')">
          <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 20l5-5"/>
            <path d="M14 10l6-6"/>
            <circle cx="10" cy="14" r="3"/>
          </svg>
          <div class="role-name">타자</div>
        </div>
        <div id="rolePitcherCard" class="role-card" onclick="selectOnboardRole('pitcher')">
          <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="6" r="2.5"/>
            <path d="M12 8.5v5M12 13.5l-4 4M12 13.5l4 4"/>
            <path d="M8 10l-3 2M16 10l3 2"/>
          </svg>
          <div class="role-name">투수</div>
        </div>
      </div>
      <button id="onboardRoleNextBtn" style="margin-top:10px" onclick="onboardingRoleNext()" disabled>다음</button>
    </div>

    <div id="onboardStepPosition" class="onboard-step">
      <h3 class="onboard-title">수비 포지션 선택</h3>
      <p class="onboard-sub">타자 기준 기본 포지션을 선택하세요.</p>
      <div class="position-field">
        <svg class="field-outline" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
          <!-- foul lines -->
          <path class="line" d="M50 86 L2 40" />
          <path class="line" d="M50 86 L98 40" />
          <!-- outfield arc -->
          <path class="line" d="M2 40 Q50 -10 98 40" />
          <!-- infield dirt arc -->
          <path class="line-soft" d="M31 63 Q50 47 69 63" />
          <!-- base paths -->
          <path class="line-soft" d="M50 74 L39 63 L50 52 L61 63 Z" />
          <!-- home plate -->
          <path class="line-soft" d="M47 86 L53 86 L52 90 L50 92 L48 90 Z" />
          <!-- mound -->
          <circle class="line-soft" cx="50" cy="67" r="2.2" />
          <!-- bases -->
          <rect class="line-soft" x="37.9" y="61.9" width="2.2" height="2.2" transform="rotate(45 39 63)"/>
          <rect class="line-soft" x="59.9" y="61.9" width="2.2" height="2.2" transform="rotate(45 61 63)"/>
          <rect class="line-soft" x="48.9" y="50.9" width="2.2" height="2.2" transform="rotate(45 50 52)"/>
        </svg>
        <button class="pos-btn" data-pos="포수" style="left:50%;top:86%;" onclick="selectOnboardPosition('포수',this)">포수</button>
        <button class="pos-btn" data-pos="1루수" style="left:63%;top:66%;" onclick="selectOnboardPosition('1루수',this)">1루수</button>
        <button class="pos-btn" data-pos="2루수" style="left:55.5%;top:58%;" onclick="selectOnboardPosition('2루수',this)">2루수</button>
        <button class="pos-btn" data-pos="3루수" style="left:37%;top:66%;" onclick="selectOnboardPosition('3루수',this)">3루수</button>
        <button class="pos-btn" data-pos="유격수" style="left:44.5%;top:58%;" onclick="selectOnboardPosition('유격수',this)">유격수</button>
        <button class="pos-btn" data-pos="좌익수" style="left:28%;top:36%;" onclick="selectOnboardPosition('좌익수',this)">좌익수</button>
        <button class="pos-btn" data-pos="중견수" style="left:50%;top:27%;" onclick="selectOnboardPosition('중견수',this)">중견수</button>
        <button class="pos-btn" data-pos="우익수" style="left:72%;top:36%;" onclick="selectOnboardPosition('우익수',this)">우익수</button>
      </div>
      <button id="onboardPositionPreviewBtn" style="margin-top:10px" onclick="onboardingShowPreviewFromSelection()" disabled>미리보기</button>
    </div>

    <div id="onboardStepPitcherType" class="onboard-step">
      <h3 class="onboard-title">투수 프로필 설정</h3>
      <p class="onboard-sub">운영 역할, 주력 구종, 릴리스/투구손을 선택하세요.</p>
      <div class="pitcher-type-grid">
        <div>
          <div class="pitcher-help">운영 역할</div>
          <div class="pitcher-role-grid" style="margin-top:8px;">
            <button class="pitcher-role-card" onclick="selectOnboardPitcherType('선발투수', this)">선발투수</button>
            <button class="pitcher-role-card" onclick="selectOnboardPitcherType('중간투수', this)">중간투수</button>
            <button class="pitcher-role-card" onclick="selectOnboardPitcherType('마무리투수', this)">마무리투수</button>
          </div>
        </div>
        <div>
          <div class="pitcher-help">주력 구종 (복수 선택)</div>
          <div class="pitch-zone">
            <div class="pitch-zone-core">
              <button class="pitch-zone-btn" style="grid-column:1;grid-row:1;" onclick="toggleOnboardPitchType('직구', this)">직구</button>
              <button class="pitch-zone-btn" style="grid-column:2;grid-row:1;" onclick="toggleOnboardPitchType('투심', this)">투심</button>
              <button class="pitch-zone-btn" style="grid-column:3;grid-row:1;" onclick="toggleOnboardPitchType('커터', this)">커터</button>
              <button class="pitch-zone-btn" style="grid-column:1;grid-row:2;" onclick="toggleOnboardPitchType('슬라이더', this)">슬라이더</button>
              <button class="pitch-zone-btn" style="grid-column:2;grid-row:2;" onclick="toggleOnboardPitchType('스위퍼', this)">스위퍼</button>
              <button class="pitch-zone-btn" style="grid-column:3;grid-row:2;" onclick="toggleOnboardPitchType('커브', this)">커브</button>
              <button class="pitch-zone-btn" style="grid-column:1;grid-row:3;" onclick="toggleOnboardPitchType('체인지업', this)">체인지업</button>
              <button class="pitch-zone-btn" style="grid-column:2;grid-row:3;" onclick="toggleOnboardPitchType('스플리터', this)">스플리터</button>
              <button class="pitch-zone-btn" style="grid-column:3;grid-row:3;" onclick="toggleOnboardPitchType('포크', this)">포크</button>
            </div>
          </div>
        </div>
        <div>
          <div class="pitcher-help">릴리스 포인트</div>
          <div class="release-grid" style="margin-top:8px;">
            <button class="release-card release-point-card" onclick="selectOnboardReleasePoint('오버핸드', this)">오버핸드</button>
            <button class="release-card release-point-card" onclick="selectOnboardReleasePoint('쓰리쿼터', this)">쓰리쿼터</button>
            <button class="release-card release-point-card" onclick="selectOnboardReleasePoint('사이드암', this)">사이드암</button>
          </div>
          <div class="pitcher-help" style="margin-top:10px;">투구 손</div>
          <div class="hand-grid" style="margin-top:8px;">
            <button class="release-card hand-card" onclick="selectOnboardThrowHand('우완', this)">우완</button>
            <button class="release-card hand-card" onclick="selectOnboardThrowHand('좌완', this)">좌완</button>
          </div>
        </div>
      </div>
      <button id="onboardPitcherPreviewBtn" style="margin-top:10px" onclick="onboardingShowPreviewFromSelection()" disabled>미리보기</button>
    </div>
  </div>
</div>
<div class="header">
  <h1 style="margin:0;font-size:18px;font-weight:700;letter-spacing:1px;display:flex;align-items:center;justify-content:center;gap:8px;">
    <svg width="22" height="22" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="32" fill="white"/>
      <path d="M30 30 C20 45, 20 55, 30 70" stroke="#c1121f" stroke-width="3" fill="none"/>
      <path d="M70 30 C80 45, 80 55, 70 70" stroke="#c1121f" stroke-width="3" fill="none"/>
    </svg>
    <span>StatDeck</span>
  </h1>
  <div style="font-size:11px;color:#888;margin-top:4px;">Track. Analyze. Dominate the Diamond.</div>
</div>
<div class="container">

<div id="inputSection" class="section">
<div class="section-hero input-hero">
  <h4 class="section-hero-title">GAME ENTRY STUDIO</h4>
  <div class="section-hero-sub">기록 입력부터 시즌 데이터 구축까지 한 화면에서 빠르게.</div>
</div>

<div class="card">
<h3>시즌 선택</h3>
<select id="seasonSelect" onchange="changeSeason()">
<option value="2022">2022</option>
<option value="2023">2023</option>
<option value="2024">2024</option>
<option value="2025">2025</option>
<option value="2026" selected>2026</option>
<option value="2027">2027</option>
<option value="2028">2028</option>
</select>
</div>

<div class="card entry-card">
<div class="entry-top">
  <h3>경기 기록 입력</h3>
  <p>핵심 기록 먼저 입력하고, 필요한 항목만 펼쳐서 입력하세요.</p>
</div>
<div class="entry-core-grid">
  <input type="date" id="gameDate">
  <input type="text" id="gameName" placeholder="경기 이름">
  <select id="result">
    <option value="W">승 (W)</option>
    <option value="L">패 (L)</option>
  </select>
  <select id="gameCondition">
    <option value="normal">컨디션: 보통</option>
    <option value="good">컨디션: 좋음</option>
    <option value="bad">컨디션: 나쁨</option>
  </select>
</div>

<div class="entry-role-picker">
  <button type="button" id="entryRoleBatterBtn" class="entry-role-btn active" onclick="setEntryRole('batter')">타자 기록</button>
  <button type="button" id="entryRolePitcherBtn" class="entry-role-btn" onclick="setEntryRole('pitcher')">투수 기록</button>
</div>
<select id="entryRole" onchange="changeEntryRole()" class="hidden">
  <option value="batter" selected>타자 기록</option>
  <option value="pitcher">투수 기록</option>
</select>

<div class="batter-fields">
  <div class="entry-group">
    <div class="entry-group-title">핵심 타격 기록</div>
    <div class="entry-mini-grid">
      <input type="number" id="ab" placeholder="타수">
      <input type="number" id="hits" placeholder="안타">
      <input type="number" id="hr" placeholder="홈런">
      <input type="number" id="bb" placeholder="볼넷">
      <input type="number" id="rbi" placeholder="타점">
      <input type="number" id="run" placeholder="득점">
    </div>
  </div>
  <button type="button" class="entry-collapse-btn" data-open="세부 타자 기록 펼치기" data-close="세부 타자 기록 접기" onclick="toggleEntryGroup('batterAdvancedGroup', this)">세부 타자 기록 펼치기</button>
  <div id="batterAdvancedGroup" class="entry-advanced hidden">
    <div class="entry-mini-grid">
      <input type="number" id="double" placeholder="2루타">
      <input type="number" id="triple" placeholder="3루타">
      <input type="number" id="hbp" placeholder="사구">
      <input type="number" id="sb" placeholder="도루">
    </div>
  </div>
</div>

<div class="pitcher-fields hidden">
  <div class="entry-group">
    <div class="entry-group-title">핵심 투수 기록</div>
    <div class="entry-mini-grid">
      <input type="number" id="ipOuts" placeholder="이닝 아웃카운트">
      <input type="number" id="er" placeholder="자책점 (ER)">
      <input type="number" id="so" placeholder="탈삼진">
      <input type="number" id="pHits" placeholder="피안타">
      <input type="number" id="pBb" placeholder="볼넷 허용">
      <input type="number" id="pHr" placeholder="피홈런">
    </div>
  </div>
  <button type="button" class="entry-collapse-btn" data-open="세부 투수 기록 펼치기" data-close="세부 투수 기록 접기" onclick="toggleEntryGroup('pitcherAdvancedGroup', this)">세부 투수 기록 펼치기</button>
  <div id="pitcherAdvancedGroup" class="entry-advanced hidden">
    <div class="entry-mini-grid">
      <input type="number" id="ra" placeholder="실점 (R)">
      <input type="number" id="pHbp" placeholder="사구 허용 (HBP)">
    </div>
  </div>
  <button type="button" class="entry-collapse-btn" data-open="구속 입력 펼치기" data-close="구속 입력 접기" onclick="toggleEntryGroup('pitcherVeloGroup', this)">구속 입력 펼치기</button>
  <div id="pitcherVeloGroup" class="entry-advanced hidden">
    <div class="input-subtitle">구종별 평균속도 (km/h)</div>
    <div class="pitch-speed-grid">
      <input type="number" id="veloFastball" placeholder="직구">
      <input type="number" id="veloTwoSeam" placeholder="투심">
      <input type="number" id="veloCutter" placeholder="커터">
      <input type="number" id="veloSlider" placeholder="슬라이더">
      <input type="number" id="veloSweeper" placeholder="스위퍼">
      <input type="number" id="veloCurve" placeholder="커브">
      <input type="number" id="veloChangeup" placeholder="체인지업">
      <input type="number" id="veloSplitter" placeholder="스플리터">
      <input type="number" id="veloFork" placeholder="포크">
    </div>
    <div class="input-subtitle">구종별 최고속도 (km/h)</div>
    <div class="pitch-speed-grid">
      <input type="number" id="maxVeloFastball" placeholder="직구">
      <input type="number" id="maxVeloTwoSeam" placeholder="투심">
      <input type="number" id="maxVeloCutter" placeholder="커터">
      <input type="number" id="maxVeloSlider" placeholder="슬라이더">
      <input type="number" id="maxVeloSweeper" placeholder="스위퍼">
      <input type="number" id="maxVeloCurve" placeholder="커브">
      <input type="number" id="maxVeloChangeup" placeholder="체인지업">
      <input type="number" id="maxVeloSplitter" placeholder="스플리터">
      <input type="number" id="maxVeloFork" placeholder="포크">
    </div>
  </div>
</div>
<button id="saveGameBtn" onclick="saveGame()">경기 추가</button>
</div>

</div>

<div id="statsSection" class="section">
<div class="section-hero stats-hero">
  <h4 class="section-hero-title">PERFORMANCE DASHBOARD</h4>
  <div class="section-hero-sub">시즌 지표, 변화 추세, 주간 리포트를 한눈에 확인.</div>
</div>

<div class="card">
<h3>시즌 지표</h3>
<div class="mode-toggle">
  <button id="batterModeBtn" class="mode-btn active" onclick="setStatsMode('batter')">타자 템플릿</button>
  <button id="pitcherModeBtn" class="mode-btn" onclick="setStatsMode('pitcher')">투수 템플릿</button>
</div>
<div class="stat-grid" id="seasonStats"></div>
</div>

<div class="card">
<h3>경기별 타율</h3>
<canvas id="gameAvgChart"></canvas>
</div>

<div class="card">
<h3>누적 타율</h3>
<canvas id="cumulativeAvgChart"></canvas>
</div>

<div class="card">
<h3>주간 리포트</h3>
<div id="weeklyReport" class="weekly-report"></div>
</div>

</div>

<div id="calendarSection" class="section">
<div class="section-hero calendar-hero">
  <h4 class="section-hero-title">SEASON CALENDAR</h4>
  <div class="section-hero-sub">날짜별 성과 흐름과 경기 디테일을 한 번에 확인.</div>
</div>

<div class="card">
<div class="calendar-toolbar">
  <span id="calendarTitle" class="calendar-title">월간 캘린더</span>
  <div class="calendar-nav">
    <button class="calendar-nav-btn" onclick="changeMonth(-1)">◀</button>
    <button class="calendar-nav-btn" onclick="changeMonth(1)">▶</button>
  </div>
</div>
<div id="calendar" class="calendar modern"></div>
<div id="dayRecord" class="day-record"></div>
</div>

</div>

<div id="quoteSection" class="section">
  <div class="section-hero mental-hero">
    <h4 class="section-hero-title">MENTAL JOURNAL</h4>
    <div class="section-hero-sub">경기 직후 생각을 남기고 다음 경기 루틴으로 연결.</div>
  </div>
  <div class="quote-header">
    <div>
      <h2>⚾ Mental Entry</h2>
      <p>오늘 경기의 집중 포인트를 짧게 기록</p>
    </div>
    <div class="quote-count" id="quoteCount">0 ENTRIES</div>
  </div>

  <div class="quote-input-card">
    <div class="note-label">GAME MIND CHECK</div>
    <div class="mental-prompt-row">
      <div class="mental-prompt">잘된 선택 1개</div>
      <div class="mental-prompt">흔들린 이유 1개</div>
      <div class="mental-prompt">다음 경기 목표 1개</div>
    </div>
    <textarea id="quoteInput" class="note-area"
      placeholder="예) 2스트 이후에도 눈높이가 유지됐다. 다음 경기는 첫 타석에서 중심이동을 더 빠르게 가져간다."></textarea>
    <div class="quote-input-footer">
      <div class="quote-tip">한 문장씩 명확하게 남기면 복기할 때 더 좋습니다.</div>
      <button onclick="addQuote()">저장하기</button>
    </div>
  </div>

  <div id="quoteList" class="quote-grid modern"></div>
  <div id="noteModal" class="note-modal">
  <div class="note-modal-content premium-modal">
    <div class="modal-top">
      <div class="modal-label">MENTAL JOURNAL</div>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>

    <div id="noteModalText" class="note-modal-text premium-text"></div>

    <div class="modal-divider"></div>
</div>
</div>
</div>

<div id="profileSection" class="section active">
  <div class="card profile-card">
    <div class="profile-subtabs">
      <button id="profileHomeTabBtn" class="profile-subtab-btn active" onclick="switchProfileSubTab('home')">프로필 홈</button>
      <button id="profileManageTabBtn" class="profile-subtab-btn" onclick="switchProfileSubTab('manage')">기록 관리</button>
    </div>

    <div id="profileHomePanel" class="profile-panel">
      <div class="profile-top">
        <div class="avatar-wrap">
          <img id="profileAvatarPreview" alt="profile avatar">
        </div>
        <div class="profile-meta">
          <h3 id="profileNamePreview">Player</h3>
          <p id="profileBioPreview">나만의 플레이 스타일과 목표를 기록하세요.</p>
          <div class="profile-season-note" id="profileSeasonNote">2026 시즌 기준</div>
          <div class="profile-streak" id="profileStreakLine">연속 기록 없음</div>
          <div class="profile-badge-head">
            <div class="profile-badge-title">업적 뱃지</div>
            <div style="display:flex;align-items:center;gap:6px;">
              <span class="profile-badge-count" id="profileBadgeCount">0개</span>
              <button type="button" class="badge-guide-btn" onclick="showBadgeGuide()">기준 보기</button>
            </div>
          </div>
          <div class="profile-badges" id="profileBadgeList"></div>
        </div>
      </div>

      <div class="profile-stat-grid">
        <div class="profile-stat">
          <div class="label">경기</div>
          <div class="value" id="profileGamesCount">0</div>
        </div>
        <div class="profile-stat">
          <div class="label" id="profileMetric1Label">타율</div>
          <div class="value" id="profileAvgValue">0.000</div>
        </div>
        <div class="profile-stat">
          <div class="label" id="profileMetric2Label">총 타수</div>
          <div class="value" id="profileAbTotal">0</div>
        </div>
      </div>

      <button class="profile-ai-entry" onclick="goToAnalytics()">
        <span class="profile-ai-title">AI SCOUT REPORT</span>
        <span class="profile-ai-sub">폼 분석 · 슬럼프 감지 · 다음 경기 예측 보기</span>
      </button>

      <button class="upload-btn" style="margin-top:10px;" onclick="toggleProfileEditor(true)">프로필 수정하기</button>

      <div id="profileEditorPanel" class="profile-editor hidden">
        <div class="profile-label">닉네임</div>
        <input id="profileNameInput" class="profile-input" type="text" maxlength="24" placeholder="예) Clutch Hitter">

        <div class="profile-label">소개</div>
        <textarea id="profileBioInput" class="profile-textarea" maxlength="140" placeholder="예) 타석 집중력과 루틴을 꾸준히 만든다."></textarea>

        <div class="profile-upload-row">
          <button class="upload-btn" onclick="triggerAvatarUpload()">프로필 사진</button>
          <button class="upload-btn" onclick="triggerGalleryUpload()">갤러리 업로드</button>
        </div>
        <input id="avatarFileInput" type="file" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
        <input id="galleryFileInput" type="file" accept="image/*" multiple style="display:none" onchange="handleGalleryUpload(event)">

        <button style="margin-top:10px;" onclick="saveProfile()">프로필 저장</button>
        <button class="upload-btn" style="margin-top:8px;" onclick="toggleProfileEditor(false)">취소</button>

        <div class="profile-label">PHOTO GRID</div>
        <div id="profileGrid" class="profile-grid"></div>
      </div>
    </div>

    <div id="profileManagePanel" class="profile-panel hidden">
      <div class="profile-label">기록 관리 작업</div>
      <div class="profile-actions">
        <button class="upload-btn" onclick="switchToInputForEdit()">기록 수정하러 가기</button>
        <button class="upload-btn" onclick="resetGameForm()">수정 모드 해제</button>
        <button class="danger" onclick="resetCurrentSeasonRecords()">현재 시즌 리셋</button>
        <button class="danger" onclick="resetAllRecords()">전체 기록 리셋</button>
        <button class="danger" onclick="resetToNewUser()">신규 사용자로 되돌리기</button>
      </div>
      <div class="profile-label">최근 기록</div>
      <div id="recordManageList" class="record-manage-list"></div>
    </div>
  </div>
</div>

</div>

<div class="tab-bar">
  <div class="tab" onclick="switchTab('inputSection',this)">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 5v14M5 12h14"/>
    </svg>
    <span>입력</span>
  </div>
  <div class="tab" onclick="switchTab('statsSection',this)">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 20V10M10 20V4M16 20v-6M22 20V2"/>
    </svg>
    <span>통계</span>
  </div>
  <div class="tab" onclick="switchTab('calendarSection',this)">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
      <line x1="16" y1="2" x2="16" y2="6"/>
      <line x1="8" y1="2" x2="8" y2="6"/>
      <line x1="3" y1="10" x2="21" y2="10"/>
    </svg>
    <span>캘린더</span>
  </div>
  <div class="tab" onclick="switchTab('quoteSection',this)">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 21h18M7 17V9M12 17V5M17 17v-3"/>
    </svg>
    <span>Mental</span>
  </div>
<div class="tab active" onclick="switchTab('profileSection',this)">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M20 21a8 8 0 0 0-16 0"/>
    <circle cx="12" cy="8" r="4"/>
  </svg>
  <span>Profile</span>
</div>

</div>

<script>
const DB_NAME = "statdeck-db";
const DB_VERSION = 1;
const KV_STORE = "kv";

let seasonKey="2026";
let allData={2026:[],2027:[],2028:[]};
let games=[];
let selectedDate=null;
let currentViewDate=new Date();
let editingGame=null;
let profileData = {
  name:"Player",
  bio:"나만의 플레이 스타일과 목표를 기록하세요.",
  avatar:"",
  photos:[],
  role:"batter",
  position:"",
  pitcherType:"",
  pitchArsenal:[],
  releasePoint:"",
  throwHand:"",
  onboarded:false
};
if(!Array.isArray(profileData.photos)) profileData.photos = [];
let profileEditMode = false;
let profileSubTab = "home";
let statsMode = "batter";
let onboardDraft = { name:"", bio:"", role:"", position:"", pitcherType:"", pitchArsenal:[], releasePoint:"", throwHand:"" };
let onboardingPreviewTimers = [];
const seasonSelectEl = document.getElementById("seasonSelect");
let quotes = [];

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(KV_STORE)){
        db.createObjectStore(KV_STORE, { keyPath:"key" });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}

async function idbGet(key){
  try{
    const db = await openDB();
    return await new Promise((resolve,reject)=>{
      const tx = db.transaction(KV_STORE, "readonly");
      const store = tx.objectStore(KV_STORE);
      const req = store.get(key);
      req.onsuccess = ()=> resolve(req.result ? req.result.value : undefined);
      req.onerror = ()=> reject(req.error);
    });
  }catch(e){
    return undefined;
  }
}

async function idbSet(key, value){
  try{
    const db = await openDB();
    return await new Promise((resolve,reject)=>{
      const tx = db.transaction(KV_STORE, "readwrite");
      tx.objectStore(KV_STORE).put({key, value});
      tx.oncomplete = ()=> resolve(true);
      tx.onerror = ()=> reject(tx.error);
    });
  }catch(e){
    return false;
  }
}

function readLegacyJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  }catch(e){
    return fallback;
  }
}

function readLegacyText(key, fallback){
  const raw = localStorage.getItem(key);
  return raw || fallback;
}

async function loadStoreValue(key, fallback, legacyReader){
  const fromIDB = await idbGet(key);
  if(fromIDB !== undefined) return fromIDB;
  const legacy = legacyReader ? legacyReader() : fallback;
  await idbSet(key, legacy);
  return legacy;
}

function persistSeasonData(){
  void idbSet("seasonData", allData);
}

function persistLastSeason(){
  void idbSet("lastSeasonKey", seasonKey);
}

async function initializeApp(){
  seasonKey = await loadStoreValue("lastSeasonKey", "2026", ()=>readLegacyText("lastSeasonKey", "2026"));
  allData = await loadStoreValue("seasonData", {2026:[],2027:[],2028:[]}, ()=>readLegacyJSON("seasonData",{2026:[],2027:[],2028:[]}));
  profileData = await loadStoreValue("profileData", profileData, ()=>readLegacyJSON("profileData", profileData));
  quotes = await loadStoreValue("quotes", [], ()=>readLegacyJSON("quotes", []));

  if(!allData[seasonKey]) allData[seasonKey] = [];
  games = allData[seasonKey] || [];
  if(!Array.isArray(profileData.photos)) profileData.photos = [];
  if(!Array.isArray(profileData.pitchArsenal)) profileData.pitchArsenal = [];
  if(typeof profileData.releasePoint !== "string") profileData.releasePoint = "";
  if(typeof profileData.throwHand !== "string") profileData.throwHand = "";
  if(!profileData.role) profileData.role = "batter";
  if(typeof profileData.onboarded !== "boolean"){
    profileData.onboarded = profileData.name && profileData.name !== "Player";
  }
  quotes = normalizeQuotes(quotes);
  saveQuotes();
  if(seasonSelectEl) seasonSelectEl.value = seasonKey;
  const roleEl = document.getElementById("entryRole");
  if(roleEl) roleEl.value = profileData.role || "batter";
  if(profileData.role === "pitcher") setStatsMode("pitcher");
  else setStatsMode("batter");
  changeEntryRole();
  renderQuotes();
  render();
  setupOnboardingIfNeeded();
}

function normalizeQuotes(list){
  return list
    .map((entry)=>{
      if(typeof entry === 'string'){
        return { text: entry, createdAt: null };
      }
      if(entry && typeof entry.text === 'string'){
        return {
          text: entry.text,
          createdAt: entry.createdAt || null
        };
      }
      return null;
    })
    .filter(Boolean);
}

function saveQuotes(){
  void idbSet("quotes", quotes);
}

function saveProfileData(){
  void idbSet("profileData", profileData);
}

function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>resolve(reader.result);
    reader.onerror = ()=>reject(new Error("file read failed"));
    reader.readAsDataURL(file);
  });
}

function renderProfile(){
  const avatar = document.getElementById("profileAvatarPreview");
  const namePreview = document.getElementById("profileNamePreview");
  const bioPreview = document.getElementById("profileBioPreview");
  const seasonNote = document.getElementById("profileSeasonNote");
  const streakLineEl = document.getElementById("profileStreakLine");
  const badgeCountEl = document.getElementById("profileBadgeCount");
  const badgeListEl = document.getElementById("profileBadgeList");
  const gamesCountEl = document.getElementById("profileGamesCount");
  const metric1LabelEl = document.getElementById("profileMetric1Label");
  const metric2LabelEl = document.getElementById("profileMetric2Label");
  const avgEl = document.getElementById("profileAvgValue");
  const abEl = document.getElementById("profileAbTotal");
  const nameInput = document.getElementById("profileNameInput");
  const bioInput = document.getElementById("profileBioInput");
  const homeTabBtn = document.getElementById("profileHomeTabBtn");
  const manageTabBtn = document.getElementById("profileManageTabBtn");
  const homePanel = document.getElementById("profileHomePanel");
  const managePanel = document.getElementById("profileManagePanel");
  const editorPanel = document.getElementById("profileEditorPanel");
  const grid = document.getElementById("profileGrid");
  const recordList = document.getElementById("recordManageList");
  if(!avatar || !namePreview || !bioPreview || !seasonNote || !streakLineEl || !badgeCountEl || !badgeListEl || !gamesCountEl || !metric1LabelEl || !metric2LabelEl || !avgEl || !abEl || !nameInput || !bioInput || !homeTabBtn || !manageTabBtn || !homePanel || !managePanel || !editorPanel || !grid || !recordList) return;

  const safeName = (profileData.name || "Player").trim() || "Player";
  const safeBio = (profileData.bio || "나만의 플레이 스타일과 목표를 기록하세요.").trim() || "나만의 플레이 스타일과 목표를 기록하세요.";

  namePreview.innerText = safeName;
  bioPreview.innerText = safeBio;
  nameInput.value = safeName;
  bioInput.value = safeBio;
  const isHomeTab = profileSubTab !== "manage";
  homeTabBtn.classList.toggle("active", isHomeTab);
  manageTabBtn.classList.toggle("active", !isHomeTab);
  homePanel.classList.toggle("hidden", !isHomeTab);
  managePanel.classList.toggle("hidden", isHomeTab);
  editorPanel.classList.toggle("hidden", !profileEditMode);
  avatar.src = profileData.avatar || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23111111'/%3E%3Ccircle cx='50' cy='38' r='18' fill='%23363636'/%3E%3Crect x='22' y='62' width='56' height='26' rx='13' fill='%232b2b2b'/%3E%3C/svg%3E";

  const seasonGames = allData[seasonKey] || [];
  const roleSeasonGames = seasonGames.filter((g)=>(g.role || "batter") === (profileData.role || "batter"));
  const totalAB = roleSeasonGames.reduce((sum,g)=>sum + (g.ab || 0), 0);
  const totalHits = roleSeasonGames.reduce((sum,g)=>sum + (g.hits || 0), 0);
  const seasonAvg = totalAB ? (totalHits / totalAB).toFixed(3) : "0.000";
  const totalIPOuts = roleSeasonGames.reduce((sum,g)=>sum + (g.ipOuts || 0), 0);
  const totalER = roleSeasonGames.reduce((sum,g)=>sum + (g.er || 0), 0);
  const totalSO = roleSeasonGames.reduce((sum,g)=>sum + (g.so || 0), 0);
  const totalBF = roleSeasonGames.reduce((sum,g)=>sum + (g.ipOuts || 0) + (g.pHits || 0) + (g.pBb || 0) + (g.pHbp || 0), 0);
  const era = totalIPOuts ? ((totalER * 27) / totalIPOuts).toFixed(2) : "0.00";
  const kRate = totalBF ? ((totalSO / totalBF) * 100).toFixed(1) : "0.0";
  const roleLabel = profileData.role === "pitcher" ? "투수" : "타자";
  const extraLabel = profileData.role === "pitcher"
    ? `${profileData.pitcherType ? ` · ${profileData.pitcherType}` : ""}${profileData.throwHand ? ` · ${profileData.throwHand}` : ""}${profileData.releasePoint ? ` · ${profileData.releasePoint}` : ""}`
    : (profileData.position ? ` · ${profileData.position}` : "");
  seasonNote.innerText = `${seasonKey} 시즌 기준 · ${roleLabel}${extraLabel}`;
  streakLineEl.innerText = getRoleStreakText(roleSeasonGames, profileData.role || "batter");
  const badges = getRoleBadges(roleSeasonGames, profileData.role || "batter");
  badgeCountEl.innerText = `${badges.length}개`;
  badgeListEl.innerHTML = badges.length
    ? badges.map((b)=>`<span class="badge-chip">${b}</span>`).join("")
    : `<span class="badge-chip" style="opacity:.7;">기록 누적 중 · 첫 뱃지 도전</span>`;
  gamesCountEl.innerText = String(roleSeasonGames.length);
  if(profileData.role === "pitcher"){
    metric1LabelEl.innerText = "ERA";
    metric2LabelEl.innerText = "삼진율";
    avgEl.innerText = era;
    abEl.innerText = `${kRate}%`;
  }else{
    metric1LabelEl.innerText = "타율";
    metric2LabelEl.innerText = "총 타수";
    avgEl.innerText = seasonAvg;
    abEl.innerText = String(totalAB);
  }

  const photos = (profileData.photos || []).slice(0,9);
  if(!photos.length){
    grid.innerHTML = `<div class="profile-photo" style="display:flex;align-items:center;justify-content:center;color:#676767;font-size:11px;">사진 없음</div>`;
  }else{
    grid.innerHTML = photos.map((src,idx)=>`
      <div class="profile-photo">
        <img src="${src}" alt="profile photo ${idx+1}">
        <button class="photo-remove" onclick="removeProfilePhoto(${idx})">✕</button>
      </div>
    `).join("");
  }

  const recentGames = getCalendarGames()
    .sort((a,b)=>String(b.date).localeCompare(String(a.date)))
    .slice(0,8);

  if(!recentGames.length){
    recordList.innerHTML = `<div class="record-item" style="text-align:center;color:#767676;">저장된 경기 기록이 없습니다.</div>`;
    return;
  }

  recordList.innerHTML = recentGames.map((g)=>{
    const role = g.role || "batter";
    const avg = g.ab ? (g.hits/g.ab).toFixed(3) : "0.000";
    const era = g.ipOuts ? (((g.er||0)*27)/(g.ipOuts||1)).toFixed(2) : "0.00";
    const velo = getAvgPitchVelo(g);
    const topVelo = getTopPitchVelo(g);
    const walksPlus = (g.pBb||0) + (g.pHbp||0);
    const title = g.name || "경기명 없음";
    const line = role === "pitcher"
      ? `IP ${((g.ipOuts||0)/3).toFixed(1)} · R ${g.ra||0} · ERA ${era} · SO ${g.so||0} · 사사구 ${walksPlus}${velo ? ` · 평균구속 ${velo}` : ""}${topVelo ? ` · 최고구속 ${topVelo}` : ""}`
      : `${g.hits}H ${g.hr || 0}HR ${g.bb || 0}BB · AVG ${avg}`;
    const condMap = { good:"좋음", normal:"보통", bad:"나쁨" };
    const condText = condMap[g.condition] || "보통";
    return `
      <div class="record-item">
        <div class="record-item-top">
          <span>${g.date} · ${g._season} 시즌</span>
          <span>${g.result || "-"}</span>
        </div>
        <div class="record-item-title">${title}</div>
        <div class="record-item-line">${line} · 컨디션 ${condText}</div>
        <div class="record-item-actions">
          <button class="mini-btn" onclick="startEditGame('${g._season}', ${g._index})">수정</button>
          <button class="mini-btn danger" onclick="deleteGame('${g._season}', ${g._index})">삭제</button>
        </div>
      </div>
    `;
  }).join("");
}

function onboardingStep(step){
  const steps = {
    start: "onboardStep1",
    preview: "onboardStep2",
    role: "onboardStepRole",
    position: "onboardStepPosition",
    pitcherType: "onboardStepPitcherType"
  };
  Object.values(steps).forEach((id)=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove("active");
  });
  const target = document.getElementById(steps[step] || steps.start);
  if(target) target.classList.add("active");
  if(step !== "preview"){
    onboardingPreviewTimers.forEach((timer)=>clearTimeout(timer));
    onboardingPreviewTimers = [];
  }
}

function setupOnboardingIfNeeded(){
  const root = document.getElementById("onboarding");
  if(!root) return;
  if(profileData.onboarded){
    root.classList.add("hidden");
    return;
  }
  root.classList.remove("hidden");
  onboardingStep("start");
}

function onboardingToRole(){
  const name = (document.getElementById("onboardName")?.value || "").trim();
  const bio = (document.getElementById("onboardBio")?.value || "").trim();
  if(!name || !bio) return;
  onboardDraft.name = name;
  onboardDraft.bio = bio;
  onboardingStep("role");
}

function renderOnboardingPreview(){
  onboardingStep("preview");
  const preview = document.getElementById("onboardPreviewText");
  if(!preview) return;
  onboardingPreviewTimers.forEach((timer)=>clearTimeout(timer));
  onboardingPreviewTimers = [];
  const roleLabel = onboardDraft.role === "pitcher" ? "투수" : "타자";
  const extra = onboardDraft.role === "pitcher"
    ? [onboardDraft.pitcherType, onboardDraft.throwHand, onboardDraft.releasePoint].filter(Boolean).join(" · ")
    : onboardDraft.position;
  const seasonLine = `${seasonKey} 시즌 기준 · ${roleLabel}${extra ? ` · ${extra}` : ""}`;
  const frames = [onboardDraft.name, onboardDraft.bio, seasonLine];
  let idx = 0;

  function showFrame(){
    preview.textContent = "";
    preview.classList.remove("onboard-fade");
    preview.textContent = frames[idx];
    const fadeTimer = setTimeout(()=> preview.classList.add("onboard-fade"), 10);
    onboardingPreviewTimers.push(fadeTimer);
    idx += 1;
    if(idx < frames.length){
      const nextTimer = setTimeout(showFrame, 1200);
      onboardingPreviewTimers.push(nextTimer);
    }
  }

  showFrame();
}

function selectOnboardRole(role){
  onboardDraft.role = role;
  onboardDraft.position = "";
  onboardDraft.pitcherType = "";
  onboardDraft.pitchArsenal = [];
  onboardDraft.releasePoint = "";
  onboardDraft.throwHand = "";
  document.querySelectorAll(".pitcher-role-card").forEach((card)=>card.classList.remove("active"));
  document.querySelectorAll(".pitch-zone-btn").forEach((chip)=>chip.classList.remove("active"));
  document.querySelectorAll(".release-card").forEach((card)=>card.classList.remove("active"));
  document.querySelectorAll(".hand-card").forEach((card)=>card.classList.remove("active"));
  const pitcherPreviewBtn = document.getElementById("onboardPitcherPreviewBtn");
  if(pitcherPreviewBtn) pitcherPreviewBtn.disabled = true;
  const batter = document.getElementById("roleBatterCard");
  const pitcher = document.getElementById("rolePitcherCard");
  const nextBtn = document.getElementById("onboardRoleNextBtn");
  if(batter) batter.classList.toggle("active", role === "batter");
  if(pitcher) pitcher.classList.toggle("active", role === "pitcher");
  if(nextBtn) nextBtn.disabled = false;
}

function onboardingRoleNext(){
  if(onboardDraft.role === "pitcher"){
    onboardingStep("pitcherType");
  }else{
    onboardingStep("position");
  }
}

function selectOnboardPosition(position, el){
  onboardDraft.position = position;
  document.querySelectorAll(".pos-btn").forEach((btn)=>btn.classList.remove("active"));
  if(el) el.classList.add("active");
  const finishBtn = document.getElementById("onboardPositionPreviewBtn");
  if(finishBtn) finishBtn.disabled = false;
}

function selectOnboardPitcherType(type, el){
  onboardDraft.pitcherType = type;
  onboardDraft.position = "투수";
  document.querySelectorAll(".pitcher-role-card").forEach((card)=>card.classList.remove("active"));
  if(el) el.classList.add("active");
  updatePitcherOnboardingReady();
}

function toggleOnboardPitchType(type, el){
  const list = Array.isArray(onboardDraft.pitchArsenal) ? onboardDraft.pitchArsenal : [];
  const next = list.includes(type) ? list.filter((v)=>v!==type) : [...list, type];
  onboardDraft.pitchArsenal = next.slice(0, 5);
  if(el) el.classList.toggle("active", onboardDraft.pitchArsenal.includes(type));
  updatePitcherOnboardingReady();
}

function selectOnboardReleasePoint(point, el){
  onboardDraft.releasePoint = point;
  document.querySelectorAll(".release-point-card").forEach((card)=>card.classList.remove("active"));
  if(el) el.classList.add("active");
  updatePitcherOnboardingReady();
}

function selectOnboardThrowHand(hand, el){
  onboardDraft.throwHand = hand;
  document.querySelectorAll(".hand-card").forEach((card)=>card.classList.remove("active"));
  if(el) el.classList.add("active");
  updatePitcherOnboardingReady();
}

function updatePitcherOnboardingReady(){
  const btn = document.getElementById("onboardPitcherPreviewBtn");
  if(!btn) return;
  btn.disabled = !(onboardDraft.pitcherType && (onboardDraft.pitchArsenal || []).length && onboardDraft.releasePoint && onboardDraft.throwHand);
}

function onboardingShowPreviewFromSelection(){
  if(!onboardDraft.name || !onboardDraft.bio || !onboardDraft.role) return;
  if(onboardDraft.role === "batter" && !onboardDraft.position) return;
  if(onboardDraft.role === "pitcher" && (!onboardDraft.pitcherType || !(onboardDraft.pitchArsenal || []).length || !onboardDraft.releasePoint || !onboardDraft.throwHand)) return;
  renderOnboardingPreview();
}

function finishOnboarding(){
  if(!onboardDraft.name || !onboardDraft.bio || !onboardDraft.role) return;
  if(onboardDraft.role === "batter" && !onboardDraft.position) return;
  if(onboardDraft.role === "pitcher" && (!onboardDraft.pitcherType || !(onboardDraft.pitchArsenal || []).length || !onboardDraft.releasePoint || !onboardDraft.throwHand)) return;
  profileData.name = onboardDraft.name;
  profileData.bio = onboardDraft.bio;
  profileData.role = onboardDraft.role;
  profileData.position = onboardDraft.position || "";
  profileData.pitcherType = onboardDraft.pitcherType || "";
  profileData.pitchArsenal = (onboardDraft.pitchArsenal || []).slice(0,5);
  profileData.releasePoint = onboardDraft.releasePoint || "";
  profileData.throwHand = onboardDraft.throwHand || "";
  profileData.onboarded = true;
  saveProfileData();
  const root = document.getElementById("onboarding");
  if(root) root.classList.add("hidden");
  const roleEl = document.getElementById("entryRole");
  if(roleEl){
    roleEl.value = profileData.role;
    changeEntryRole();
  }
  setStatsMode(profileData.role === "pitcher" ? "pitcher" : "batter");
  renderProfile();
}

function switchProfileSubTab(tab){
  profileSubTab = tab === "manage" ? "manage" : "home";
  renderProfile();
}

function toggleProfileEditor(force){
  if(typeof force === "boolean"){
    profileEditMode = force;
  }else{
    profileEditMode = !profileEditMode;
  }
  renderProfile();
}

function saveProfile(){
  const nameInput = document.getElementById("profileNameInput");
  const bioInput = document.getElementById("profileBioInput");
  profileData.name = (nameInput?.value || "").trim() || "Player";
  profileData.bio = (bioInput?.value || "").trim() || "나만의 플레이 스타일과 목표를 기록하세요.";
  profileData.photos = (profileData.photos || []).slice(0,9);
  saveProfileData();
  profileEditMode = false;
  renderProfile();
}

function triggerAvatarUpload(){
  const input = document.getElementById("avatarFileInput");
  if(input) input.click();
}

function triggerGalleryUpload(){
  const input = document.getElementById("galleryFileInput");
  if(input) input.click();
}

async function handleAvatarUpload(event){
  const file = event.target.files?.[0];
  if(!file) return;
  try{
    profileData.avatar = await readFileAsDataURL(file);
    saveProfileData();
    renderProfile();
  }catch(e){}
  event.target.value = "";
}

async function handleGalleryUpload(event){
  const files = Array.from(event.target.files || []);
  if(!files.length) return;

  const remains = Math.max(0, 9 - (profileData.photos || []).length);
  const targets = files.slice(0, remains);
  const encoded = [];

  for(const file of targets){
    try{
      const dataUrl = await readFileAsDataURL(file);
      encoded.push(dataUrl);
    }catch(e){}
  }

  profileData.photos = [...(profileData.photos || []), ...encoded].slice(0,9);
  saveProfileData();
  renderProfile();
  event.target.value = "";
}

function removeProfilePhoto(index){
  profileData.photos = (profileData.photos || []).filter((_,i)=>i!==index);
  saveProfileData();
  renderProfile();
}

function switchToInputForEdit(){
  const inputTab = document.querySelector(".tab[onclick*=\"inputSection\"]");
  if(inputTab) inputTab.click();
}

function resetCurrentSeasonRecords(){
  if(!confirm(`${seasonKey} 시즌 기록을 모두 초기화할까요?`)) return;
  allData[seasonKey] = [];
  games = allData[seasonKey];
  selectedDate = null;
  resetGameForm();
  persistSeasonData();
  render();
}

function resetAllRecords(){
  if(!confirm("모든 시즌 기록을 초기화할까요?")) return;
  Object.keys(allData).forEach((key)=>{ allData[key] = []; });
  games = allData[seasonKey] || [];
  selectedDate = null;
  resetGameForm();
  persistSeasonData();
  render();
}

async function resetToNewUser(){
  if(!confirm("신규 사용자 상태로 되돌릴까요?")) return;
  if(!confirm("기록, 프로필, Mental Entry가 모두 초기화됩니다. 계속할까요?")) return;

  seasonKey = "2026";
  allData = {2026:[],2027:[],2028:[]};
  games = allData[seasonKey];
  selectedDate = null;
  currentViewDate = new Date();
  editingGame = null;
  profileEditMode = false;
  profileSubTab = "home";
  statsMode = "batter";
  onboardDraft = { name:"", bio:"", role:"", position:"", pitcherType:"", pitchArsenal:[], releasePoint:"", throwHand:"" };
  profileData = {
    name:"Player",
    bio:"나만의 플레이 스타일과 목표를 기록하세요.",
    avatar:"",
    photos:[],
    role:"batter",
    position:"",
    pitcherType:"",
    pitchArsenal:[],
    releasePoint:"",
    throwHand:"",
    onboarded:false
  };
  quotes = [];

  if(seasonSelectEl) seasonSelectEl.value = seasonKey;
  const roleEl = document.getElementById("entryRole");
  if(roleEl) roleEl.value = "batter";

  await idbSet("seasonData", allData);
  await idbSet("lastSeasonKey", seasonKey);
  await idbSet("profileData", profileData);
  await idbSet("quotes", quotes);

  localStorage.removeItem("seasonData");
  localStorage.removeItem("lastSeasonKey");
  localStorage.removeItem("profileData");
  localStorage.removeItem("quotes");

  resetGameForm();
  renderQuotes();
  render();
  setupOnboardingIfNeeded();
}

function updateQuoteCount(){
  const countEl = document.getElementById('quoteCount');
  if(!countEl) return;
  const count = quotes.length;
  countEl.textContent = `${count} ${count === 1 ? 'ENTRY' : 'ENTRIES'}`;
}

function formatEntryDate(createdAt){
  if(!createdAt) return '날짜 없음';
  const date = new Date(createdAt);
  if(Number.isNaN(date.getTime())) return '날짜 없음';
  return `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;
}

function addQuote(){
  const input = document.getElementById('quoteInput');
  const text = input.value.trim();
  if(!text) return;

  quotes.unshift({
    text,
    createdAt: new Date().toISOString()
  });

  saveQuotes();
  input.value = "";
  animateTyping(text);
}

function deleteQuote(index){
  quotes.splice(index,1);
  saveQuotes();
  renderQuotes();
}

function animateTyping(text){
  const container = document.getElementById('quoteList');
  const preview = document.createElement('div');
  preview.className = 'quote-card';
  container.prepend(preview);

  let i = 0;
  function type(){
    if(i <= text.length){
      preview.innerHTML = `
        <div class="quote-text" style="white-space:pre-line;">${text.slice(0,i)}</div>
      `;
      i++;
      setTimeout(type, 10);
    } else {
      renderQuotes();
    }
  }
  type();
}

function renderQuotes(){
  const container = document.getElementById('quoteList');
  if(!container) return;

  updateQuoteCount();
  container.innerHTML = "";

  if(!quotes.length){
    container.innerHTML = `<div class="quote-empty">첫 엔트리를 남겨 보세요. 짧은 한 줄이 다음 경기 집중력을 바꿉니다.</div>`;
    return;
  }

  const accentColors = ['#c1121f','#1f7a8c','#f4a261','#2a9d8f','#9c6644'];
  quotes.forEach((entry,i)=>{
    const text = typeof entry === 'string' ? entry : entry.text;
    const createdAt = typeof entry === 'string' ? null : entry.createdAt;

    const card = document.createElement('div');
    card.className = 'quote-card';
    card.style.setProperty('--entry-accent', accentColors[i % accentColors.length]);
    card.onclick = (e)=>{
      if(e.target.classList.contains('quote-delete')) return;
      openModal(text);
    };

    card.innerHTML = `
      <div class="quote-meta top">
        <span>ENTRY-${String(quotes.length - i).padStart(2,'0')}</span>
        <span>${formatEntryDate(createdAt)}</span>
      </div>
      <div class="quote-text" style="white-space:pre-line;margin-top:8px;">${text}</div>
      <div class="quote-meta">
        <span>MENTAL NOTE</span>
        <span class="quote-delete" onclick="deleteQuote(${i})">삭제</span>
      </div>
    `;
    container.appendChild(card);
  });
}

function switchTab(id,el){
document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
document.getElementById(id).classList.add('active');
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
el.classList.add('active');
}

function setEntryRole(role){
  const roleEl = document.getElementById("entryRole");
  if(roleEl) roleEl.value = role;
  changeEntryRole();
}

function toggleEntryGroup(groupId, btn){
  const target = document.getElementById(groupId);
  if(!target || !btn) return;
  target.classList.toggle("hidden");
  const isOpen = !target.classList.contains("hidden");
  const openText = btn.dataset.open || "펼치기";
  const closeText = btn.dataset.close || "접기";
  btn.textContent = isOpen ? closeText : openText;
}

function changeEntryRole(){
  const roleEl = document.getElementById("entryRole");
  const role = roleEl ? roleEl.value : "batter";
  const batterFields = document.querySelector(".batter-fields");
  const pitcherFields = document.querySelector(".pitcher-fields");
  const batterBtn = document.getElementById("entryRoleBatterBtn");
  const pitcherBtn = document.getElementById("entryRolePitcherBtn");
  if(batterFields) batterFields.classList.toggle("hidden", role !== "batter");
  if(pitcherFields) pitcherFields.classList.toggle("hidden", role !== "pitcher");
  if(batterBtn) batterBtn.classList.toggle("active", role === "batter");
  if(pitcherBtn) pitcherBtn.classList.toggle("active", role === "pitcher");
}

function setStatsMode(mode){
  statsMode = mode === "pitcher" ? "pitcher" : "batter";
  const batterBtn = document.getElementById("batterModeBtn");
  const pitcherBtn = document.getElementById("pitcherModeBtn");
  if(batterBtn) batterBtn.classList.toggle("active", statsMode === "batter");
  if(pitcherBtn) pitcherBtn.classList.toggle("active", statsMode === "pitcher");
  render();
}

function changeSeason(){
seasonKey=seasonSelect.value;
persistLastSeason();
if(!allData[seasonKey]) allData[seasonKey]=[];
games=allData[seasonKey];
selectedDate=null;
render();
}

function resetGameForm(){
const gameFields = ["gameDate","gameName","ab","hits","double","triple","hr","bb","hbp","rbi","run","sb","ipOuts","ra","er","pHits","pBb","pHbp","pHr","so","veloFastball","veloTwoSeam","veloCutter","veloSlider","veloSweeper","veloCurve","veloChangeup","veloSplitter","veloFork","maxVeloFastball","maxVeloTwoSeam","maxVeloCutter","maxVeloSlider","maxVeloSweeper","maxVeloCurve","maxVeloChangeup","maxVeloSplitter","maxVeloFork"];
gameFields.forEach((id)=>{
  const el = document.getElementById(id);
  if(el) el.value = "";
});
const roleEl = document.getElementById("entryRole");
if(roleEl) roleEl.value = profileData.role || "batter";
changeEntryRole();
result.value = "W";
gameCondition.value = "normal";
["batterAdvancedGroup","pitcherAdvancedGroup","pitcherVeloGroup"].forEach((id)=>{
  const panel = document.getElementById(id);
  if(panel) panel.classList.add("hidden");
});
document.querySelectorAll(".entry-collapse-btn").forEach((btn)=>{
  if(btn.dataset.open) btn.textContent = btn.dataset.open;
});
editingGame = null;
const saveBtn = document.getElementById("saveGameBtn");
if(saveBtn) saveBtn.innerText = "경기 추가";
}

function startEditGame(season, index){
 const seasonStr = String(season);
 const list = allData[seasonStr] || [];
 const target = list[index];
 if(!target) return;

 seasonSelect.value = seasonStr;
 seasonKey = seasonStr;
 if(!allData[seasonKey]) allData[seasonKey] = [];
 games = allData[seasonKey];

 editingGame = { season: seasonStr, index };

 const roleEl = document.getElementById("entryRole");
 const role = target.role || "batter";
 if(roleEl) roleEl.value = role;
 changeEntryRole();

 gameDate.value = target.date || "";
 gameName.value = target.name || "";
 ab.value = target.ab || "";
 hits.value = target.hits || "";
 double.value = target.double || "";
 triple.value = target.triple || "";
 hr.value = target.hr || "";
 bb.value = target.bb || "";
 hbp.value = target.hbp || "";
 rbi.value = target.rbi || "";
 run.value = target.run || "";
 sb.value = target.sb || "";
 ipOuts.value = target.ipOuts || "";
 ra.value = target.ra || "";
 er.value = target.er || "";
 pHits.value = target.pHits || "";
 pBb.value = target.pBb || "";
 pHbp.value = target.pHbp || "";
 pHr.value = target.pHr || "";
 so.value = target.so || "";
 veloFastball.value = target.veloFastball || "";
 veloTwoSeam.value = target.veloTwoSeam || "";
 veloCutter.value = target.veloCutter || "";
 veloSlider.value = target.veloSlider || "";
 veloSweeper.value = target.veloSweeper || "";
 veloCurve.value = target.veloCurve || "";
 veloChangeup.value = target.veloChangeup || "";
 veloSplitter.value = target.veloSplitter || "";
 veloFork.value = target.veloFork || "";
 maxVeloFastball.value = target.maxVeloFastball || "";
 maxVeloTwoSeam.value = target.maxVeloTwoSeam || "";
 maxVeloCutter.value = target.maxVeloCutter || "";
 maxVeloSlider.value = target.maxVeloSlider || "";
 maxVeloSweeper.value = target.maxVeloSweeper || "";
 maxVeloCurve.value = target.maxVeloCurve || "";
 maxVeloChangeup.value = target.maxVeloChangeup || "";
 maxVeloSplitter.value = target.maxVeloSplitter || "";
 maxVeloFork.value = target.maxVeloFork || "";
 result.value = target.result || "W";
 gameCondition.value = target.condition || "normal";

 const saveBtn = document.getElementById("saveGameBtn");
 if(saveBtn) saveBtn.innerText = "수정 저장";

 const inputTab = document.querySelector(".tab[onclick*=\"inputSection\"]");
 if(inputTab) inputTab.click();
}

function deleteGame(season, index){
 const seasonStr = String(season);
 if(!allData[seasonStr] || !allData[seasonStr][index]) return;
 if(!confirm("이 경기 기록을 삭제할까요?")) return;

 allData[seasonStr].splice(index,1);

 if(editingGame && editingGame.season === seasonStr){
  if(editingGame.index === index){
   resetGameForm();
  }else if(editingGame.index > index){
   editingGame.index -= 1;
  }
 }

 if(seasonKey === seasonStr){
  games = allData[seasonStr];
 }

 persistSeasonData();
 render();
}

function saveGame() {
const gameName = document.getElementById('gameName');
persistLastSeason();
if(!allData[seasonKey]) allData[seasonKey]=[];
games = allData[seasonKey];
const role = (document.getElementById("entryRole")?.value) || "batter";
const game = {
date: gameDate.value || new Date().toISOString().slice(0,10),
name: gameName.value || "",
role,
ab: +ab.value || 0,
hits: +hits.value || 0,
double: +double.value || 0,
triple: +triple.value || 0,
hr: +hr.value || 0,
bb: +bb.value || 0,
hbp: +hbp.value || 0,
rbi: +rbi.value || 0,
run: +run.value || 0,
sb: +sb.value || 0,
ipOuts: +ipOuts.value || 0,
ra: +ra.value || 0,
er: +er.value || 0,
pHits: +pHits.value || 0,
pBb: +pBb.value || 0,
pHbp: +pHbp.value || 0,
pHr: +pHr.value || 0,
so: +so.value || 0,
veloFastball: +veloFastball.value || 0,
veloTwoSeam: +veloTwoSeam.value || 0,
veloCutter: +veloCutter.value || 0,
veloSlider: +veloSlider.value || 0,
veloSweeper: +veloSweeper.value || 0,
veloCurve: +veloCurve.value || 0,
veloChangeup: +veloChangeup.value || 0,
veloSplitter: +veloSplitter.value || 0,
veloFork: +veloFork.value || 0,
maxVeloFastball: +maxVeloFastball.value || 0,
maxVeloTwoSeam: +maxVeloTwoSeam.value || 0,
maxVeloCutter: +maxVeloCutter.value || 0,
maxVeloSlider: +maxVeloSlider.value || 0,
maxVeloSweeper: +maxVeloSweeper.value || 0,
maxVeloCurve: +maxVeloCurve.value || 0,
maxVeloChangeup: +maxVeloChangeup.value || 0,
maxVeloSplitter: +maxVeloSplitter.value || 0,
maxVeloFork: +maxVeloFork.value || 0,
condition: gameCondition.value || "normal",
result: result.value
};

if(editingGame && editingGame.season === seasonKey && allData[seasonKey][editingGame.index]){
  allData[seasonKey][editingGame.index] = game;
}else{
  games.push(game);
  allData[seasonKey] = games;
}

persistSeasonData();
resetGameForm();
render();
}

function changeMonth(dir){
currentViewDate.setMonth(currentViewDate.getMonth()+dir);
render();
}

function goToAnalytics(){
  const role = encodeURIComponent(profileData.role || "batter");
  const pos = encodeURIComponent(profileData.position || "");
  const pitcherType = encodeURIComponent(profileData.pitcherType || "");
  const pitchArsenal = encodeURIComponent((profileData.pitchArsenal || []).join(","));
  const releasePoint = encodeURIComponent(profileData.releasePoint || "");
  const throwHand = encodeURIComponent(profileData.throwHand || "");
  location.href = `analytics.html?season=${encodeURIComponent(seasonKey)}&role=${role}&position=${pos}&pitcherType=${pitcherType}&pitchArsenal=${pitchArsenal}&releasePoint=${releasePoint}&throwHand=${throwHand}`;
}

function getCalendarGames(){
  return Object.entries(allData)
    .flatMap(([season,list]) =>
      (list || []).map((g,index)=>({
        ...g,
        _season:season,
        _index:index
      }))
    )
    .filter(g=>g && g.date);
}

function getPitchVelocities(g){
  return [
    g.veloFastball, g.veloTwoSeam, g.veloCutter, g.veloSlider, g.veloSweeper,
    g.veloCurve, g.veloChangeup, g.veloSplitter, g.veloFork
  ].map((v)=>+v || 0).filter((v)=>v > 0);
}

function getPitchMaxVelocities(g){
  return [
    g.maxVeloFastball, g.maxVeloTwoSeam, g.maxVeloCutter, g.maxVeloSlider, g.maxVeloSweeper,
    g.maxVeloCurve, g.maxVeloChangeup, g.maxVeloSplitter, g.maxVeloFork
  ].map((v)=>+v || 0).filter((v)=>v > 0);
}

function getAvgPitchVelo(g){
  const list = getPitchVelocities(g);
  if(!list.length) return null;
  return (list.reduce((a,b)=>a+b,0) / list.length).toFixed(1);
}

function getTopPitchVelo(g){
  const list = getPitchMaxVelocities(g);
  if(!list.length) return null;
  return Math.max(...list).toFixed(1);
}

function calcStreak(gamesList, predicate){
  const sorted = [...gamesList].sort((a,b)=>String(b.date||"").localeCompare(String(a.date||"")));
  let count = 0;
  for(const g of sorted){
    if(predicate(g)) count += 1;
    else break;
  }
  return count;
}

function getRoleBadges(roleGames, role){
  if(!roleGames.length) return [];
  if(role === "pitcher"){
    const outs = roleGames.reduce((s,g)=>s+(g.ipOuts||0),0);
    const er = roleGames.reduce((s,g)=>s+(g.er||0),0);
    const so = roleGames.reduce((s,g)=>s+(g.so||0),0);
    const wins = roleGames.filter((g)=>g.result==="W").length;
    const era = outs ? (er*27/outs) : 99;
    const topVelo = roleGames.flatMap((g)=>getPitchMaxVelocities(g));
    const badges = [];
    if(era <= 2.50 && roleGames.length >= 5) badges.push("ERA 장인");
    if(so >= 30) badges.push("K 머신");
    if(wins >= 5) badges.push("클러치 마운드");
    if(topVelo.length && Math.max(...topVelo) >= 145) badges.push("파이어볼러");
    return badges.slice(0,4);
  }
  const ab = roleGames.reduce((s,g)=>s+(g.ab||0),0);
  const hits = roleGames.reduce((s,g)=>s+(g.hits||0),0);
  const hr = roleGames.reduce((s,g)=>s+(g.hr||0),0);
  const bb = roleGames.reduce((s,g)=>s+(g.bb||0),0);
  const avg = ab ? (hits/ab) : 0;
  const badges = [];
  if(avg >= 0.35 && ab >= 20) badges.push("정교한 타격");
  if(hr >= 5) badges.push("파워 배트");
  if((hits + bb) >= 25) badges.push("출루 마스터");
  if(roleGames.filter((g)=>(g.hits||0)>=2).length >= 3) badges.push("멀티히트 감각");
  return badges.slice(0,4);
}

function getRoleStreakText(roleGames, role){
  if(!roleGames.length) return "연속 기록 없음";
  if(role === "pitcher"){
    const scoreless = calcStreak(roleGames, (g)=>(g.er||0)===0);
    const k = calcStreak(roleGames, (g)=>(g.so||0)>=1);
    if(scoreless >= 2) return `연속 무실점 ${scoreless}경기`;
    if(k >= 2) return `연속 탈삼진 경기 ${k}경기`;
    return "최근 투수 기록 축적 중";
  }
  const hit = calcStreak(roleGames, (g)=>(g.hits||0)>=1);
  const onBase = calcStreak(roleGames, (g)=>((g.hits||0)+(g.bb||0)+(g.hbp||0))>0);
  if(hit >= 2) return `연속 안타 ${hit}경기`;
  if(onBase >= 2) return `연속 출루 ${onBase}경기`;
  return "최근 타격 기록 축적 중";
}

function showBadgeGuide(){
  const role = profileData.role || "batter";
  if(role === "pitcher"){
    alert(
`투수 업적 뱃지 기준
- ERA 장인: 시즌 ERA 2.50 이하 (5경기 이상)
- K 머신: 시즌 탈삼진 30개 이상
- 클러치 마운드: 시즌 5승 이상
- 파이어볼러: 최고구속 145km/h 이상`
    );
    return;
  }
  alert(
`타자 업적 뱃지 기준
- 정교한 타격: 시즌 AVG 0.350 이상 (20타수 이상)
- 파워 배트: 시즌 홈런 5개 이상
- 출루 마스터: 시즌 안타+볼넷 25개 이상
- 멀티히트 감각: 2안타 이상 경기 3번 이상`
  );
}

function renderCalendar(){
const cal=document.getElementById("calendar");
cal.innerHTML="";
const weekdays=["일","월","화","수","목","금","토"];
weekdays.forEach(d=>{
 const w=document.createElement("div");
 w.className="weekday";
 w.innerText=d;
 cal.appendChild(w);
});
const year=currentViewDate.getFullYear();
const month=currentViewDate.getMonth();
document.getElementById("calendarTitle").innerText = `${year}년 ${month+1}월`;
const firstDay = new Date(year, month, 1).getDay();
const last=new Date(year,month+1,0);
const recordMap={};

const calendarGames = getCalendarGames();
calendarGames.forEach(g=>{
if(!recordMap[g.date])recordMap[g.date]=[];
recordMap[g.date].push(g);
});

for(let i=0;i<firstDay;i++){
 const blank=document.createElement("div");
 blank.className="day-empty";
 cal.appendChild(blank);
}

for(let i=1;i<=last.getDate();i++){
const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
const div=document.createElement("div");
div.className="day";
div.innerText=i;

if(recordMap[dateStr]){
div.classList.add("has");

const totalHits=recordMap[dateStr].reduce((a,b)=>a+((b.role==="pitcher")?(b.pHits||0):(b.hits||0)),0);
if(totalHits>=4)div.classList.add("heat-high");
else if(totalHits>=2)div.classList.add("heat-mid");

if(recordMap[dateStr].some(g=>g.result==='W')){
div.classList.add("win");
}
}

if(selectedDate===dateStr)div.classList.add("selected");

div.onclick=()=>{
selectedDate=dateStr;
showDayRecord(recordMap[dateStr]||[]);
render();
};

cal.appendChild(div);
}
}

function showDayRecord(list) {
  const dayRecord = document.getElementById('dayRecord');
  dayRecord.classList.remove('active');
  if (!list.length) {
    dayRecord.innerHTML = "<div style='text-align:center;color:#666'>기록 없음</div>";
    return;
  }

  // 경기 이름(대회명) 블록
  const titleBlock = list[0]?.name ?
    `<div style="font-size:13px;font-weight:600;margin-bottom:12px;color:#ddd">${list[0].name}</div>`
    : "";

  let total = { ab: 0, hits: 0, double: 0, triple: 0, hr: 0, bb: 0, hbp: 0, rbi: 0, run: 0, sb: 0, wins: 0 };
  let pTotal = { outs:0, ra:0, er:0, pHits:0, pBb:0, pHbp:0, pHr:0, so:0, wins:0 };
  list.forEach(g => {
    total.ab += g.ab || 0;
    total.hits += g.hits || 0;
    total.hr += g.hr || 0;
    total.bb += g.bb || 0;
    total.rbi += g.rbi || 0;
    total.run += g.run || 0;
    total.sb += g.sb || 0;
    total.double += g.double || 0;
    total.triple += g.triple || 0;
    total.hbp += g.hbp || 0;
    if (g.result === 'W') total.wins++;

    pTotal.outs += g.ipOuts || 0;
    pTotal.ra += g.ra || 0;
    pTotal.er += g.er || 0;
    pTotal.pHits += g.pHits || 0;
    pTotal.pBb += g.pBb || 0;
    pTotal.pHbp += g.pHbp || 0;
    pTotal.pHr += g.pHr || 0;
    pTotal.so += g.so || 0;
    if (g.result === 'W') pTotal.wins++;
  });

  const pitcherGames = list.filter((g)=>(g.role || "batter") === "pitcher");
  const isPitcherOnly = pitcherGames.length === list.length;

  const avg = total.ab ? (total.hits / total.ab).toFixed(3) : "0.000";
  const winRate = list.length ? ((total.wins / list.length) * 100).toFixed(1) : "0.0";

  const singlesD = total.hits - total.double - total.triple - total.hr;
  const tbD = singlesD + (total.double * 2) + (total.triple * 3) + (total.hr * 4);
  const slgD = total.ab ? (tbD / total.ab) : 0;
  const obpDenomD = (total.ab + total.bb + total.hbp);
  const obpD = obpDenomD ? ((total.hits + total.bb + total.hbp) / obpDenomD) : 0;
  const opsD = (obpD + slgD).toFixed(3);
  const isoD = total.ab ? (slgD - (total.hits / total.ab)).toFixed(3) : "0.000";

  const obpDisplayD = obpD.toFixed(3);
  const slgDisplayD = slgD.toFixed(3);
  const xbhD = total.double + total.triple + total.hr;
  const tbDisplayD = tbD;
  const gameRows = list.map((g)=>{
    const role = g.role || "batter";
    const lineAvg = g.ab ? (g.hits / g.ab).toFixed(3) : "0.000";
    const era = g.ipOuts ? ((g.er || 0)*27/(g.ipOuts || 1)).toFixed(2) : "0.00";
    const velo = getAvgPitchVelo(g);
    const topVelo = getTopPitchVelo(g);
    const walksPlus = (g.pBb || 0) + (g.pHbp || 0);
    const line = role === "pitcher"
      ? `IP ${((g.ipOuts||0)/3).toFixed(1)} · R ${g.ra || 0} · SO ${g.so || 0} · 사사구 ${walksPlus} · 피HR ${g.pHr || 0} · ERA ${era}${velo ? ` · 평균구속 ${velo}` : ""}${topVelo ? ` · 최고구속 ${topVelo}` : ""}`
      : `${g.hits || 0}H ${g.hr || 0}HR ${g.bb || 0}BB · AVG ${lineAvg}`;
    const gameTitle = g.name ? g.name : "경기명 없음";
    const seasonText = g._season ? `${g._season} 시즌` : "시즌 미확인";
    const editAction = (g._season !== undefined && g._index !== undefined)
      ? `<button class="mini-btn" onclick="startEditGame('${g._season}', ${g._index})">수정</button>`
      : "";
    const deleteAction = (g._season !== undefined && g._index !== undefined)
      ? `<button class="mini-btn danger" onclick="deleteGame('${g._season}', ${g._index})">삭제</button>`
      : "";

    return `
      <div class="day-game-item">
        <div class="day-game-top">
          <span>${seasonText}</span>
          <span>${g.result || "-"}</span>
        </div>
        <div class="day-game-name">${gameTitle}</div>
        <div class="day-game-line">${line}</div>
        <div class="day-game-actions">
          ${editAction}
          ${deleteAction}
        </div>
      </div>
    `;
  }).join("");

  if(isPitcherOnly){
    const eraD = pTotal.outs ? ((pTotal.er*27)/pTotal.outs).toFixed(2) : "0.00";
    const whipD = pTotal.outs ? (((pTotal.pHits+pTotal.pBb+pTotal.pHbp)/(pTotal.outs/3))).toFixed(2) : "0.00";
    const bfD = pTotal.outs + pTotal.pHits + pTotal.pBb + pTotal.pHbp;
    const kRateD = bfD ? ((pTotal.so / bfD) * 100).toFixed(1) : "0.0";
    const oavgD = (pTotal.outs + pTotal.pHits) ? (pTotal.pHits / (pTotal.outs + pTotal.pHits)).toFixed(3) : "0.000";
    const walksPlusD = pTotal.pBb + pTotal.pHbp;
    const veloListD = pitcherGames.flatMap((g)=>getPitchVelocities(g));
    const maxVeloListD = pitcherGames.flatMap((g)=>getPitchMaxVelocities(g));
    const avgVeloD = veloListD.length ? (veloListD.reduce((a,b)=>a+b,0) / veloListD.length).toFixed(1) : null;
    const topVeloD = maxVeloListD.length ? Math.max(...maxVeloListD).toFixed(1) : null;
    dayRecord.innerHTML = `
    ${titleBlock}
    <div class='stat-grid'>
      <div class='stat-box'><small>ERA</small><h2>${eraD}</h2></div>
      <div class='stat-box'><small>실점</small><h2>${pTotal.ra}</h2></div>
      <div class='stat-box'><small>삼진율</small><h2>${kRateD}%</h2></div>
      <div class='stat-box'><small>피안타율</small><h2>${oavgD}</h2></div>
      <div class='stat-box'><small>WHIP</small><h2>${whipD}</h2></div>
      <div class='stat-box'><small>사사구</small><h2>${walksPlusD}</h2></div>
      <div class='stat-box'><small>피홈런</small><h2>${pTotal.pHr}</h2></div>
      <div class='stat-box'><small>SO</small><h2>${pTotal.so}</h2></div>
      <div class='stat-box'><small>평균구속</small><h2>${avgVeloD || "-"}</h2></div>
      <div class='stat-box'><small>최고구속</small><h2>${topVeloD || "-"}</h2></div>
      <div class='stat-box'><small>피안타</small><h2>${pTotal.pHits}</h2></div>
      <div class='stat-box'><small>ER</small><h2>${pTotal.er}</h2></div>
      <div class='stat-box'><small>이닝</small><h2>${(pTotal.outs/3).toFixed(1)}</h2></div>
      <div class='stat-box'><small>승률</small><h2>${list.length ? ((pTotal.wins / list.length) * 100).toFixed(1):"0.0"}%</h2></div>
      <div class='stat-box'><small>경기</small><h2>${list.length}</h2></div>
    </div>
    <div class="day-games">${gameRows}</div>
    `;
  }else{
    dayRecord.innerHTML = `
    ${titleBlock}
    <div class='stat-grid'>
      <div class='stat-box'><small>AVG</small><h2>${avg}</h2></div>
      <div class='stat-box'><small>HR</small><h2>${total.hr}</h2></div>
      <div class='stat-box'><small>HIT</small><h2>${total.hits}</h2></div>
      <div class='stat-box'><small>BB</small><h2>${total.bb}</h2></div>
      <div class='stat-box'><small>타점</small><h2>${total.rbi}</h2></div>
      <div class='stat-box'><small>득점</small><h2>${total.run}</h2></div>
      <div class='stat-box'><small>SB</small><h2>${total.sb}</h2></div>
      <div class='stat-box'><small>OPS</small><h2>${opsD}</h2></div>
      <div class='stat-box'><small>ISO</small><h2>${isoD}</h2></div>
      <div class='stat-box'><small>OBP</small><h2>${obpDisplayD}</h2></div>
      <div class='stat-box'><small>SLG</small><h2>${slgDisplayD}</h2></div>
      <div class='stat-box'><small>XBH</small><h2>${xbhD}</h2></div>
      <div class='stat-box'><small>TB</small><h2>${tbDisplayD}</h2></div>
      <div class='stat-box'><small>승률</small><h2>${winRate}%</h2></div>
      <div class='stat-box'><small>경기</small><h2>${list.length}</h2></div>
    </div>
    <div class="day-games">${gameRows}</div>
    `;
  }
  setTimeout(() => {
    dayRecord.classList.add('active');
  }, 50);
}

function renderWeeklyReport(batterGames, pitcherGames){
  const report = document.getElementById("weeklyReport");
  if(!report) return;
  const now = new Date();
  const weekAgo = new Date(now);
  weekAgo.setDate(now.getDate()-6);

  const recent = games.filter((g)=>{
    if(!g.date) return false;
    const d = new Date(g.date);
    return d >= new Date(weekAgo.toDateString()) && d <= now;
  });

  const recentBatters = recent.filter((g)=>(g.role || "batter") === "batter");
  const recentPitchers = recent.filter((g)=>(g.role || "batter") === "pitcher");

  if(!recent.length){
    report.innerHTML = `<h4>이번 주 리포트</h4><p>최근 7일 경기 기록이 없습니다.</p>`;
    return;
  }

  const batterAB = recentBatters.reduce((s,g)=>s+(g.ab||0),0);
  const batterH = recentBatters.reduce((s,g)=>s+(g.hits||0),0);
  const batterAvg = batterAB ? (batterH/batterAB).toFixed(3) : "0.000";
  const batterHR = recentBatters.reduce((s,g)=>s+(g.hr||0),0);
  const batterRBI = recentBatters.reduce((s,g)=>s+(g.rbi||0),0);

  const outs = recentPitchers.reduce((s,g)=>s+(g.ipOuts||0),0);
  const raTotal = recentPitchers.reduce((s,g)=>s+(g.ra||0),0);
  const erTotal = recentPitchers.reduce((s,g)=>s+(g.er||0),0);
  const soTotal = recentPitchers.reduce((s,g)=>s+(g.so||0),0);
  const bbTotal = recentPitchers.reduce((s,g)=>s+(g.pBb||0),0);
  const hbpTotal = recentPitchers.reduce((s,g)=>s+(g.pHbp||0),0);
  const hrAllowTotal = recentPitchers.reduce((s,g)=>s+(g.pHr||0),0);
  const hAllowTotal = recentPitchers.reduce((s,g)=>s+(g.pHits||0),0);
  const era = outs ? ((erTotal*27)/outs).toFixed(2) : "0.00";
  const whip = outs ? (((hAllowTotal+bbTotal+hbpTotal)/(outs/3))).toFixed(2) : "0.00";
  const battersFaced = outs + hAllowTotal + bbTotal + hbpTotal;
  const kRate = battersFaced ? ((soTotal/battersFaced)*100).toFixed(1) : "0.0";
  const oavg = (outs + hAllowTotal) ? (hAllowTotal/(outs + hAllowTotal)).toFixed(3) : "0.000";
  const walksPlus = bbTotal + hbpTotal;
  const weeklyVeloList = recentPitchers.flatMap((g)=>getPitchVelocities(g));
  const weeklyMaxVeloList = recentPitchers.flatMap((g)=>getPitchMaxVelocities(g));
  const weeklyAvgVelo = weeklyVeloList.length ? (weeklyVeloList.reduce((a,b)=>a+b,0) / weeklyVeloList.length).toFixed(1) : null;
  const weeklyTopVelo = weeklyMaxVeloList.length ? Math.max(...weeklyMaxVeloList).toFixed(1) : null;

  if(statsMode === "pitcher"){
    report.innerHTML = `<h4>이번 주 투수 리포트</h4><p>경기 ${recentPitchers.length} · ERA ${era} · 실점 ${raTotal} · WHIP ${whip}<br>삼진율 ${kRate}% · 피안타율 ${oavg} · 사사구 ${walksPlus} · 피홈런 ${hrAllowTotal}${weeklyAvgVelo ? ` · 평균구속 ${weeklyAvgVelo}` : ""}${weeklyTopVelo ? ` · 최고구속 ${weeklyTopVelo}` : ""}</p>`;
  }else{
    report.innerHTML = `<h4>이번 주 타자 리포트</h4><p>경기 ${recentBatters.length} · AVG ${batterAvg} · HR ${batterHR}<br>타점 ${batterRBI} · 타수 ${batterAB}</p>`;
  }
}

function render(){
const seasonStatsEl = document.getElementById("seasonStats");
const batterGames = games.filter((g)=>(g.role || "batter") === "batter");
const pitcherGames = games.filter((g)=>(g.role || "batter") === "pitcher");

const gameCardTitle = document.querySelector("#gameAvgChart")?.closest(".card")?.querySelector("h3");
const cumCardTitle = document.querySelector("#cumulativeAvgChart")?.closest(".card")?.querySelector("h3");

if(statsMode === "pitcher"){
  if(seasonStatsEl) seasonStatsEl.className = "stat-grid pitcher-template";
  if(gameCardTitle) gameCardTitle.innerText = "경기별 ERA";
  if(cumCardTitle) cumCardTitle.innerText = "누적 ERA";

  let outsTotal=0, raTotal=0, erTotal=0, soTotal=0, bbTotal=0, hbpTotal=0, hrAllowTotal=0, hAllowTotal=0, wins=0;
  const gameEra = [];
  const cumEra = [];
  let highlightIndex = null;

  pitcherGames.forEach((g,i)=>{
    const outs = g.ipOuts || 0;
    const er = g.er || 0;
    outsTotal += outs;
    raTotal += g.ra || 0;
    erTotal += er;
    soTotal += g.so || 0;
    bbTotal += g.pBb || 0;
    hbpTotal += g.pHbp || 0;
    hrAllowTotal += g.pHr || 0;
    hAllowTotal += g.pHits || 0;
    if(g.result === "W") wins++;

    const eraGame = outs ? (er*27)/outs : 0;
    const eraCum = outsTotal ? (erTotal*27)/outsTotal : 0;
    gameEra.push(eraGame.toFixed(2));
    cumEra.push(eraCum.toFixed(2));
    if(selectedDate && g.date === selectedDate) highlightIndex = i;
  });

  const era = outsTotal ? ((erTotal*27)/outsTotal).toFixed(2) : "0.00";
  const whip = outsTotal ? (((hAllowTotal+bbTotal+hbpTotal)/(outsTotal/3))).toFixed(2) : "0.00";
  const battersFaced = outsTotal + hAllowTotal + bbTotal + hbpTotal;
  const kRate = battersFaced ? ((soTotal/battersFaced)*100).toFixed(1) : "0.0";
  const oavg = (outsTotal + hAllowTotal) ? (hAllowTotal / (outsTotal + hAllowTotal)).toFixed(3) : "0.000";
  const walksPlus = bbTotal + hbpTotal;
  const innings = (outsTotal/3).toFixed(1);
  const seasonVeloList = pitcherGames.flatMap((g)=>getPitchVelocities(g));
  const seasonMaxVeloList = pitcherGames.flatMap((g)=>getPitchMaxVelocities(g));
  const seasonAvgVelo = seasonVeloList.length ? (seasonVeloList.reduce((a,b)=>a+b,0) / seasonVeloList.length).toFixed(1) : null;
  const seasonTopVelo = seasonMaxVeloList.length ? Math.max(...seasonMaxVeloList).toFixed(1) : null;

  if(seasonStatsEl){
    seasonStatsEl.innerHTML = `
    <div class='stat-box'><small>ERA</small><h2>${era}</h2></div>
    <div class='stat-box'><small>실점</small><h2>${raTotal}</h2></div>
    <div class='stat-box'><small>삼진율</small><h2>${kRate}%</h2></div>
    <div class='stat-box'><small>피안타율</small><h2>${oavg}</h2></div>
    <div class='stat-box'><small>WHIP</small><h2>${whip}</h2></div>
    <div class='stat-box'><small>사사구</small><h2>${walksPlus}</h2></div>
    <div class='stat-box'><small>피홈런</small><h2>${hrAllowTotal}</h2></div>
    <div class='stat-box'><small>이닝</small><h2>${innings}</h2></div>
    <div class='stat-box'><small>SO</small><h2>${soTotal}</h2></div>
    <div class='stat-box'><small>평균구속</small><h2>${seasonAvgVelo || "-"}</h2></div>
    <div class='stat-box'><small>최고구속</small><h2>${seasonTopVelo || "-"}</h2></div>
    <div class='stat-box'><small>볼넷</small><h2>${bbTotal}</h2></div>
    <div class='stat-box'><small>피안타</small><h2>${hAllowTotal}</h2></div>
    <div class='stat-box'><small>HBP</small><h2>${hbpTotal}</h2></div>
    <div class='stat-box'><small>자책</small><h2>${erTotal}</h2></div>
    <div class='stat-box'><small>경기</small><h2>${pitcherGames.length}</h2></div>
    <div class='stat-box'><small>승률</small><h2>${pitcherGames.length?((wins/pitcherGames.length)*100).toFixed(1):"0.0"}%</h2></div>
    `;
  }

  renderCharts(gameEra,cumEra,highlightIndex,{min:0,max:12,baseline:3.5,reverse:true});
}else{
  if(seasonStatsEl) seasonStatsEl.className = "stat-grid";
  if(gameCardTitle) gameCardTitle.innerText = "경기별 타율";
  if(cumCardTitle) cumCardTitle.innerText = "누적 타율";

  let s={ab:0,hits:0,double:0,triple:0,hr:0,bb:0,hbp:0,rbi:0,run:0,sb:0};
  let wins=0;
  let gameAvg=[];
  let cumulativeAvg=[];
  let highlightIndex=null;

  batterGames.forEach((g,i)=>{
    s.ab+=g.ab||0;
    s.hits+=g.hits||0;
    s.double+=g.double||0;
    s.triple+=g.triple||0;
    s.hr+=g.hr||0;
    s.bb+=g.bb||0;
    s.hbp+=g.hbp||0;
    s.rbi+=g.rbi||0;
    s.run+=g.run||0;
    s.sb+=g.sb||0;
    if(g.result==='W')wins++;

    const avg=g.ab?(g.hits/g.ab):0;
    gameAvg.push(avg.toFixed(3));

    const cum=s.ab?(s.hits/s.ab):0;
    cumulativeAvg.push(cum.toFixed(3));

    if(selectedDate&&g.date===selectedDate)highlightIndex=i;
  });

  const avg=s.ab?(s.hits/s.ab).toFixed(3):"0.000";
  const winRate=batterGames.length?((wins/batterGames.length)*100).toFixed(1):"0.0";
  const singles = s.hits - s.double - s.triple - s.hr;
  const tb = singles + (s.double*2) + (s.triple*3) + (s.hr*4);
  const slg = s.ab ? (tb / s.ab) : 0;
  const obpDenom = (s.ab + s.bb + s.hbp);
  const obp = obpDenom ? ((s.hits + s.bb + s.hbp) / obpDenom) : 0;
  const ops = (obp + slg).toFixed(3);
  const iso = s.ab ? (slg - (s.hits/s.ab)).toFixed(3) : "0.000";

  const obpDisplay = obp.toFixed(3);
  const slgDisplay = slg.toFixed(3);
  const tbDisplay = tb;

  let highlightClass='';
  if(Number(avg) >= 0.350){
    highlightClass='avg-premium';
  }else if(Number(avg) >= 0.300){
    highlightClass='highlight';
  }

  let opsHighlightClass='';
  if(Number(ops) >= 1.000){
    opsHighlightClass='ops-legend';
  }else if(Number(ops) >= 0.900){
    opsHighlightClass='ops-elite';
  }

  if(seasonStatsEl){
    seasonStatsEl.innerHTML=`
    <div class='stat-box ${highlightClass}'><small>AVG</small><h2>${avg}</h2></div>
    <div class='stat-box'><small>OBP</small><h2>${obpDisplay}</h2></div>
    <div class='stat-box'><small>SLG</small><h2>${slgDisplay}</h2></div>
    <div class='stat-box ${opsHighlightClass}'><small>OPS</small><h2>${ops}</h2></div>
    <div class='stat-box'><small>ISO</small><h2>${iso}</h2></div>
    <div class='stat-box'><small>총 타수</small><h2>${s.ab}</h2></div>
    <div class='stat-box'><small>HIT</small><h2>${s.hits}</h2></div>
    <div class='stat-box'><small>HR</small><h2>${s.hr}</h2></div>
    <div class='stat-box'><small>루타</small><h2>${tbDisplay}</h2></div>
    <div class='stat-box'><small>타점</small><h2>${s.rbi}</h2></div>
    <div class='stat-box'><small>득점</small><h2>${s.run}</h2></div>
    <div class='stat-box'><small>도루</small><h2>${s.sb}</h2></div>
    <div class='stat-box'><small>BB</small><h2>${s.bb}</h2></div>
    <div class='stat-box'><small>경기</small><h2>${batterGames.length}</h2></div>
    <div class='stat-box'><small>승률</small><h2>${winRate}%</h2></div>
    `;
  }

  renderCharts(gameAvg,cumulativeAvg,highlightIndex,{min:0,max:0.6,baseline:0.3,reverse:false});
}

renderWeeklyReport(batterGames,pitcherGames);
renderCalendar();
renderProfile();
}

let chart1,chart2;
function renderCharts(g,c,hIndex,opts){
if(chart1)chart1.destroy();
if(chart2)chart2.destroy();

 const options = Object.assign({min:0,max:1,baseline:null,reverse:false}, opts || {});

const gradient1 = gameAvgChart.getContext('2d').createLinearGradient(0,0,0,200);
gradient1.addColorStop(0,'rgba(255,255,255,0.25)');
gradient1.addColorStop(1,'rgba(255,255,255,0.02)');

const gradient2 = cumulativeAvgChart.getContext('2d').createLinearGradient(0,0,0,200);
gradient2.addColorStop(0,'rgba(200,200,200,0.25)');
gradient2.addColorStop(1,'rgba(200,200,200,0.02)');

const baseLinePlugin = {
 id:'baseLine',
 afterDraw(chart){
  if(options.baseline === null || options.baseline === undefined) return;
  const {ctx,chartArea:{left,right},scales:{y}} = chart;
  const yPos = y.getPixelForValue(options.baseline);
  ctx.save();
  ctx.strokeStyle='rgba(255,255,255,0.3)';
  ctx.setLineDash([6,6]);
  ctx.beginPath();
  ctx.moveTo(left,yPos);
  ctx.lineTo(right,yPos);
  ctx.stroke();
  ctx.restore();
 }
};

chart1=new Chart(gameAvgChart,{
 type:'line',
 data:{
  labels:g.map((_,i)=>i+1),
  datasets:[{
   data:g,
   borderColor:'#ffffff',
   backgroundColor:gradient1,
   fill:true,
   tension:0.35,
   pointRadius:g.map((_,i)=>i===hIndex?6:3)
  }]
 },
 options:{
  plugins:{legend:{display:false}},
  scales:{y:{min:options.min,max:options.max,reverse:options.reverse}}
 },
 plugins:[baseLinePlugin]
});

chart2=new Chart(cumulativeAvgChart,{
 type:'line',
 data:{
  labels:c.map((_,i)=>i+1),
  datasets:[{
   data:c,
   borderColor:'#cccccc',
   backgroundColor:gradient2,
   fill:true,
   tension:0.35,
   pointRadius:c.map((_,i)=>i===hIndex?6:3)
  }]
 },
 options:{
  plugins:{legend:{display:false}},
  scales:{y:{min:options.min,max:options.max,reverse:options.reverse}}
 },
 plugins:[baseLinePlugin]
});
}

window.addEventListener('load',()=>{
 setTimeout(()=>{
   document.getElementById('splash').classList.add('hide');
 },1500);
});

initializeApp();
function openModal(text){
  document.getElementById("noteModalText").innerText = text;
  document.getElementById("noteModal").classList.add("active");
}

function closeModal(){
  document.getElementById("noteModal").classList.remove("active");
}
</script>
</body>
</html>
