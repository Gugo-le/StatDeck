<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StatDeck AI</title>
<meta name="description" content="StatDeck AI ë¶„ì„ í˜ì´ì§€. íƒ€ì/íˆ¬ìˆ˜ ê¸°ë¡ ê¸°ë°˜ìœ¼ë¡œ í¼ ë¶„ì„, ìŠ¬ëŸ¼í”„ ê°ì§€, ë‹¤ìŒ ê²½ê¸° ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.">
<meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1">
<link rel="canonical" href="https://statdeckbb.vercel.app/analytics.html">
<meta property="og:type" content="website">
<meta property="og:locale" content="ko_KR">
<meta property="og:title" content="StatDeck AI | ì•¼êµ¬ ê¸°ë¡ AI ë¶„ì„">
<meta property="og:description" content="íƒ€ì/íˆ¬ìˆ˜ ê¸°ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ AI ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.">
<meta property="og:image" content="https://statdeckbb.vercel.app/images/og-cover-1200x630.png">
<meta property="og:url" content="https://statdeckbb.vercel.app/analytics.html">
<meta property="og:site_name" content="StatDeck">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="StatDeck AI | ì•¼êµ¬ ê¸°ë¡ AI ë¶„ì„">
<meta name="twitter:description" content="StatDeck AIë¡œ ê²½ê¸° ë°ì´í„°ë¥¼ ë” ê¹Šê²Œ ë¶„ì„í•˜ì„¸ìš”.">
<meta name="twitter:image" content="https://statdeckbb.vercel.app/images/og-cover-1200x630.png">
<link rel="manifest" href="manifest.json">
<meta name="google-adsense-account" content="ca-pub-8474076663123407">
<meta name="google-site-verification" content="dVMxzBp45pzb9Go_INJ-_RvhOkPIunrrw3ZO17Nm4q0" />
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8474076663123407" crossorigin="anonymous"></script>
<link rel="icon" type="image/svg+xml" href="favicon.svg" />
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png" />
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon-180.png" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<style>
*{box-sizing:border-box}
:root{
 --bg-0:#0f1115;
 --bg-1:#141821;
 --card:#171c26;
 --card-soft:#1a202b;
 --card-border:#2a3240;
 --text:#eef1f5;
 --muted:#9ea7b4;
 --line:#303a49;
}
html{
 -webkit-text-size-adjust:100%;
 text-size-adjust:100%;
}
*{
 -webkit-tap-highlight-color:transparent;
}
body{
 margin:0;
 font-family:'Inter',sans-serif;
 background:linear-gradient(180deg,var(--bg-0),var(--bg-1));
 color:var(--text);
 padding:20px 14px 28px;
 -webkit-font-smoothing:antialiased;
 text-rendering:optimizeLegibility;
}
.page-shell{
 max-width:860px;
 margin:0 auto;
 position:relative;
 z-index:1;
}
input,
select,
textarea,
button{
 font:inherit;
 color:inherit;
 letter-spacing:inherit;
}
input,
select,
textarea{
 -webkit-appearance:none;
 appearance:none;
 background-clip:padding-box;
}
button{
 -webkit-appearance:none;
 appearance:none;
 -webkit-touch-callout:none;
}
.header{
 text-align:center;
 margin-bottom:18px;
 padding:16px 14px;
 border:1px solid var(--line);
 border-radius:20px;
 background:#141b25;
 box-shadow:none;
}
.header h1{
 margin:0;
 font-size:25px;
 font-weight:800;
 letter-spacing:.2px;
 text-shadow:none;
}
.sub{
 font-size:13px;
 color:var(--muted);
 margin-top:7px;
}
.card{
 background:var(--card);
 border:1px solid var(--card-border);
 border-radius:20px;
 padding:20px;
 margin-bottom:14px;
 transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
 position:relative;
 overflow:hidden;
}
.card:hover{
 transform:translateY(-2px);
 box-shadow:0 10px 20px rgba(0,0,0,0.2);
 border-color:#374152;
}
.card h3{
 margin:0 0 14px 0;
 font-size:12px;
 color:#d8e0ef;
 letter-spacing:.8px;
 text-transform:uppercase;
}
.result{
 font-size:14px;
 line-height:1.75;
 color:#e8effc;
 word-break:keep-all;
}
.card--hero{
 border-color:#374152;
 background:var(--card);
}
.card--hero .result{
 font-size:18px;
 font-weight:700;
 text-align:center;
 letter-spacing:.2px;
}
.card--score{
 border-color:#374152;
}
.gauge-wrap{
 display:flex;
 justify-content:center;
 align-items:center;
 padding:4px 0 2px;
}
.score-sub{
 text-align:center;
 margin-top:8px;
 color:#a8b2c0;
 font-size:12px;
}
.analysis-grid{
 display:grid;
 grid-template-columns:repeat(2,minmax(0,1fr));
 gap:14px;
 margin-bottom:14px;
}
.analysis-grid .card{
 margin-bottom:0;
}
.confidence-row{
 margin-top:10px;
 display:flex;
 justify-content:center;
 align-items:center;
 gap:8px;
 flex-wrap:wrap;
}
.confidence-badge{
 display:inline-flex;
 align-items:center;
 justify-content:center;
 padding:5px 11px;
 border-radius:999px;
 font-size:11px;
 font-weight:700;
 border:1px solid #4a5567;
 background:#232b39;
 color:#edf1f7;
}
.confidence-badge.low{
 border-color:#6a4d52;
 background:#2f2528;
 color:#f3e7ea;
}
.confidence-badge.mid{
 border-color:#66604c;
 background:#2d2a21;
 color:#f0ead9;
}
.confidence-badge.high{
 border-color:#4c6156;
 background:#223029;
 color:#e2f0e8;
}
.priority-list{
 margin:0;
 padding-left:18px;
 display:grid;
 gap:8px;
}
.priority-list li{
 font-size:13px;
 color:#dfe7f6;
}
.condition-grid{
 display:grid;
 grid-template-columns:repeat(3,minmax(0,1fr));
 gap:10px;
 margin-top:10px;
}
.condition-item{
 border:1px solid #354154;
 border-radius:12px;
 background:var(--card-soft);
 padding:10px;
}
.condition-name{
 font-size:10px;
 color:#a7b7cf;
 letter-spacing:.6px;
}
.condition-value{
 margin-top:4px;
 font-size:12px;
 color:#f0f5ff;
 font-weight:600;
}
@media (max-width:560px){
 .analysis-grid{grid-template-columns:1fr;gap:12px;}
 .condition-grid{grid-template-columns:1fr;}
}
.footer{
 margin-top:18px;
 text-align:center;
 font-size:12px;
 color:#95a8c5;
}

.sponsored-slot{
 margin-top:10px;
 padding:13px;
 border:1px solid var(--line);
 border-radius:16px;
 background:#141b25;
}

.sponsored-label{
 font-size:10px;
 letter-spacing:.8px;
 color:#b3c2d9;
 margin-bottom:6px;
}

.sponsored-placeholder{
 min-height:90px;
 border:0;
 border-radius:0;
 display:flex;
 align-items:center;
 justify-content:center;
 font-size:12px;
 color:#b4bfce;
 background:transparent;
}

.legal-links{
 margin-top:10px;
 display:flex;
 justify-content:center;
 gap:10px;
 font-size:11px;
 color:#8ea1bf;
}

.legal-links a{
 color:inherit;
 text-decoration:none;
 border-bottom:1px solid rgba(142,161,191,0.45);
}

.legal-links a:hover{
 color:#dfe9f8;
 border-bottom-color:rgba(223,233,248,0.65);
}

.back-btn{
 margin-top:14px;
 padding:10px 16px;
 background:#232d3d;
 border:1px solid #455165;
 border-radius:14px;
 color:#edf4ff;
 font-size:13px;
 cursor:pointer;
 transition:all 0.2s ease;
}

.back-btn:hover{
 background:#2c3850;
 transform:translateY(-2px);
}
@media (max-width:560px){
 .card{padding:16px}
 .header{padding:14px 12px}
 .header h1{font-size:22px}
}
</style>
</head>
<body>
<div class="page-shell">
<div class="header">
  <h1>ğŸ§  StatDeck AI</h1>
  <div class="sub">í¼ ë¶„ì„ Â· ìŠ¬ëŸ¼í”„ ê°ì§€ Â· ìœ í˜• ë¶„ì„</div>
  <button class="back-btn" onclick="location.href='index.html'">â† ê¸°ë¡ í˜ì´ì§€ë¡œ</button>
</div>

<div class="card card--hero">
  <h3 id="pregameTitle">PRE-GAME PREDICTION</h3>
  <div id="pregame" class="result"></div>
</div>

<div class="card card--score">
  <h3 id="scoreTitle">SCOUT SCORE</h3>
  <div class="gauge-wrap">
    <svg width="180" height="180" viewBox="0 0 180 180">
      <circle cx="90" cy="90" r="70" stroke="#222" stroke-width="14" fill="none"/>
      <circle id="gauge" cx="90" cy="90" r="70" 
        stroke="#4cd964" stroke-width="14" fill="none"
        stroke-linecap="round"
        stroke-dasharray="440"
        stroke-dashoffset="440"
        transform="rotate(-90 90 90)"/>
      <text id="scoreText" x="90" y="100" text-anchor="middle" 
        font-size="42" font-weight="800" fill="#fff">--</text>
    </svg>
  </div>
  <div id="scoreMsg" class="result" style="text-align:center;margin-top:10px"></div>
  <div class="confidence-row">
    <span id="confidenceBadge" class="confidence-badge">ì‹ ë¢°ë„ í™•ì¸ ì¤‘</span>
    <span id="confidenceText" class="result score-sub">ë°ì´í„° í’ˆì§ˆ ê³„ì‚° ì¤‘</span>
  </div>
  <div id="mseDisplay" class="result score-sub" style="margin-top:6px"></div>
  <div id="modelMeta" class="result score-sub" style="margin-top:4px;font-size:11px"></div>
</div>

<div class="analysis-grid">
<div class="card">
  <h3 id="recentTitle">ìµœê·¼ 5ê²½ê¸° ë¶„ì„</h3>
  <div id="recentAnalysis" class="result"></div>
</div>

<div class="card">
  <h3 id="slumpTitle">ìŠ¬ëŸ¼í”„ ê°ì§€</h3>
  <div id="slumpAnalysis" class="result"></div>
</div>

<div class="card">
  <h3 id="typeTitle">íƒ€ì ìœ í˜• ë¶„ì„</h3>
  <div id="typeAnalysis" class="result"></div>
</div>

<div class="card">
  <h3>ê°œì„  ìš°ì„ ìˆœìœ„ Top 3</h3>
  <ol id="priorityList" class="priority-list"></ol>
</div>

<div class="card">
  <h3>ì»¨ë””ì…˜ ì—°ë™ ì¸ì‚¬ì´íŠ¸</h3>
  <div id="conditionInsight" class="result"></div>
</div>

<div class="card">
  <h3>ë‹¤ìŒ ê²½ê¸° ìš´ì˜ í¬ì¸íŠ¸</h3>
  <div id="gamePlanInsight" class="result"></div>
</div>
</div>

<div class="sponsored-slot">
  <div class="sponsored-label">SPONSORED</div>
  <div class="sponsored-placeholder"></div>
</div>

<div class="footer">by StatDeck AI Engine</div>
<div class="legal-links">
  <a href="contact.html">ë¬¸ì˜/ì§€ì›</a>
  <a href="privacy.html">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
  <a href="terms.html">ì´ìš©ì•½ê´€</a>
  <a href="guide.html">ì‚¬ìš©ì„¤ëª…ì„œ</a>
</div>
</div>

<script>

const DB_NAME = "statdeck-db";
const DB_VERSION = 1;
const KV_STORE = "kv";

let seasonData = {};
let currentSeason = "";
let games = [];

function openDB(){
 return new Promise((resolve,reject)=>{
  const req = indexedDB.open(DB_NAME, DB_VERSION);
  req.onupgradeneeded = ()=>{
   const db = req.result;
   if(!db.objectStoreNames.contains(KV_STORE)){
    db.createObjectStore(KV_STORE, { keyPath:"key" });
   }
  };
  req.onsuccess = ()=> resolve(req.result);
  req.onerror = ()=> reject(req.error);
 });
}

async function idbGet(key){
 try{
  const db = await openDB();
  return await new Promise((resolve,reject)=>{
   const tx = db.transaction(KV_STORE, "readonly");
   const req = tx.objectStore(KV_STORE).get(key);
   req.onsuccess = ()=> resolve(req.result ? req.result.value : undefined);
   req.onerror = ()=> reject(req.error);
  });
 }catch(e){
  return undefined;
 }
}

async function idbSet(key, value){
 try{
  const db = await openDB();
  return await new Promise((resolve,reject)=>{
   const tx = db.transaction(KV_STORE, "readwrite");
   tx.objectStore(KV_STORE).put({key, value});
   tx.oncomplete = ()=> resolve(true);
   tx.onerror = ()=> reject(tx.error);
  });
 }catch(e){
  return false;
 }
}

function resolveSeasonKey(lastSeasonKey){
 const keys = Object.keys(seasonData);
 if(!keys.length) return "";

 const params = new URLSearchParams(location.search);
 const fromUrl = params.get("season");
 if(fromUrl && seasonData[fromUrl]) return fromUrl;

 const fromStorage = lastSeasonKey || localStorage.getItem("lastSeasonKey");
 if(fromStorage && seasonData[fromStorage]) return fromStorage;

 return keys
  .map((k)=>({key:k,count:(seasonData[k] || []).length}))
  .sort((a,b)=> b.count - a.count)[0].key;
}

function dataHash(data){
 return btoa(JSON.stringify(data));
}

function setDataInsufficient(message){
 const gaugeCircle = document.getElementById('gauge');
 document.getElementById('scoreText').textContent = "--";
 gaugeCircle.style.strokeDashoffset = 440;
 document.getElementById('scoreMsg').innerHTML = message || "ë°ì´í„° ë¶€ì¡±";
 document.getElementById('pregame').innerHTML = "ë°ì´í„° ë¶€ì¡±";
 document.getElementById('recentAnalysis').innerHTML = "ë°ì´í„° ë¶€ì¡±";
 document.getElementById('slumpAnalysis').innerHTML = "ë°ì´í„° ë¶€ì¡±";
 document.getElementById('typeAnalysis').innerHTML = "ë°ì´í„° ë¶€ì¡±";
 document.getElementById('priorityList').innerHTML = "<li>ë°ì´í„° ë¶€ì¡±</li>";
 document.getElementById('conditionInsight').innerHTML = "ë°ì´í„° ë¶€ì¡±";
 document.getElementById('gamePlanInsight').innerHTML = "ë°ì´í„° ë¶€ì¡±";
 document.getElementById('confidenceBadge').className = "confidence-badge low";
 document.getElementById('confidenceBadge').textContent = "ì‹ ë¢°ë„ ë‚®ìŒ";
 document.getElementById('confidenceText').textContent = "ìµœì†Œ 5ê²½ê¸° ì´ìƒ ëˆ„ì  í•„ìš”";
}

function setGauge(score, message){
 const gaugeCircle = document.getElementById('gauge');
 document.getElementById('scoreText').textContent = String(score);
 document.getElementById('scoreMsg').innerHTML = message;
 const circumference = 440;
 const offset = circumference - (score/100)*circumference;
 gaugeCircle.style.strokeDashoffset = offset;
}

function getPitchVelocities(game){
 return [
  game.veloFastball, game.veloTwoSeam, game.veloCutter, game.veloSlider, game.veloSweeper,
  game.veloCurve, game.veloChangeup, game.veloSplitter, game.veloFork
 ].map((v)=>+v || 0).filter((v)=>v > 0);
}

function getPitchMaxVelocities(game){
 return [
  game.maxVeloFastball, game.maxVeloTwoSeam, game.maxVeloCutter, game.maxVeloSlider, game.maxVeloSweeper,
  game.maxVeloCurve, game.maxVeloChangeup, game.maxVeloSplitter, game.maxVeloFork
 ].map((v)=>+v || 0).filter((v)=>v > 0);
}

function setConfidence(gamesCount){
 const badge = document.getElementById("confidenceBadge");
 const text = document.getElementById("confidenceText");
 if(!badge || !text) return;
 if(gamesCount >= 15){
  badge.className = "confidence-badge high";
  badge.textContent = "ì‹ ë¢°ë„ ë†’ìŒ";
  text.textContent = `í‘œë³¸ ${gamesCount}ê²½ê¸° Â· ì¶”ì„¸ íŒë‹¨ ì‹ ë¢°ë„ ì–‘í˜¸`;
  return;
 }
 if(gamesCount >= 8){
  badge.className = "confidence-badge mid";
  badge.textContent = "ì‹ ë¢°ë„ ë³´í†µ";
  text.textContent = `í‘œë³¸ ${gamesCount}ê²½ê¸° Â· ì¶”ê°€ ëˆ„ì  ì‹œ ì •í™•ë„ í–¥ìƒ`;
  return;
 }
 badge.className = "confidence-badge low";
 badge.textContent = "ì‹ ë¢°ë„ ë‚®ìŒ";
 text.textContent = `í‘œë³¸ ${gamesCount}ê²½ê¸° Â· ìµœì†Œ 8ê²½ê¸° ì´ìƒ ê¶Œì¥`;
}

function renderPriorities(items){
 const list = document.getElementById("priorityList");
 if(!list) return;
 if(!items || !items.length){
  list.innerHTML = "<li>í˜„ì¬ ëšœë ·í•œ ë³´ì™„ í¬ì¸íŠ¸ê°€ ì ìŠµë‹ˆë‹¤. ë£¨í‹´ ìœ ì§€ ì¤‘ì‹¬ìœ¼ë¡œ ìš´ì˜í•˜ì„¸ìš”.</li>";
  return;
 }
 list.innerHTML = items.slice(0,3).map((x)=>`<li>${x}</li>`).join("");
}

function renderConditionInsight(games, role){
 const el = document.getElementById("conditionInsight");
 if(!el) return;
 const conds = ["good","normal","bad"];
 const labels = {good:"ì¢‹ìŒ", normal:"ë³´í†µ", bad:"ë‚˜ì¨"};
 const entries = conds.map((key)=>{
  const list = games.filter((g)=>(g.condition || "normal") === key);
  if(!list.length) return null;
  if(role === "pitcher"){
   const outs = list.reduce((s,g)=>s + (g.ipOuts || 0), 0);
   const er = list.reduce((s,g)=>s + (g.er || 0), 0);
   const hits = list.reduce((s,g)=>s + (g.pHits || 0), 0);
   const walks = list.reduce((s,g)=>s + (g.pBb || 0) + (g.pHbp || 0), 0);
   const era = outs ? ((er*27)/outs).toFixed(2) : "0.00";
   const whip = outs ? ((hits+walks)/((outs/3)||1)).toFixed(2) : "0.00";
   return {label: labels[key], value: `ERA ${era} Â· WHIP ${whip}`};
  }
  const ab = list.reduce((s,g)=>s + (g.ab || 0), 0);
  const hits = list.reduce((s,g)=>s + (g.hits || 0), 0);
  const bb = list.reduce((s,g)=>s + (g.bb || 0), 0);
  const hbp = list.reduce((s,g)=>s + (g.hbp || 0), 0);
  const pa = list.reduce((s,g)=>s + ((g.ab || 0) + (g.bb || 0) + (g.hbp || 0)), 0);
  const avg = ab ? (hits/ab).toFixed(3) : "0.000";
  const obp = pa ? ((hits+bb+hbp)/pa).toFixed(3) : "0.000";
  return {label: labels[key], value: `AVG ${avg} Â· OBP ${obp}`};
 }).filter(Boolean);

 if(!entries.length){
  el.innerHTML = "ì»¨ë””ì…˜ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.";
  return;
 }

 el.innerHTML = `
  <div class="condition-grid">
    ${entries.map((x)=>`
      <div class="condition-item">
        <div class="condition-name">${x.label}</div>
        <div class="condition-value">${x.value}</div>
      </div>
    `).join("")}
  </div>
  <div style="margin-top:8px;font-size:12px;color:#9a9a9a;">ì»¨ë””ì…˜ ì²´í¬ë¥¼ ê³„ì† ëˆ„ì í•˜ë©´ ê²½ê¸° ì „ ë£¨í‹´ ì„¤ê³„ ì •í™•ë„ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</div>
 `;
}

function renderGamePlanInsight(role, metrics){
 const el = document.getElementById("gamePlanInsight");
 if(!el) return;

 if(role === "pitcher"){
  const points = [];
  points.push(metrics.nextEra > 4.5 ? "1. ì´ˆë°˜ 9íƒ€ì êµ¬ê°„ì€ ì½”ë„ˆ ìœ„ì£¼ë¡œ ì•ˆì „ ìš´ì˜" : "1. ì´ˆë°˜ 9íƒ€ì êµ¬ê°„ë¶€í„° ìŠ¹ë¶€êµ¬ ë¹„ìœ¨ ì ê·¹ ìš´ì˜");
  points.push(metrics.meanWhip > 1.4 ? "2. ë³¼ë„·/ì‚¬êµ¬ í•©ê³„ ëª©í‘œë¥¼ ê²½ê¸°ë‹¹ 2ê°œ ì´í•˜ë¡œ ì œí•œ" : "2. ìœ ë¦¬ì¹´ìš´íŠ¸ì—ì„œ ê²°ì •êµ¬ ë¹„ìœ¨ì„ ìœ ì§€í•´ íƒ€ì ì¹´ìš´íŠ¸ ì„ ì ");
  points.push(metrics.meanKRate < 0.18 ? "3. 2ìŠ¤íŠ¸ë¼ì´í¬ ì´í›„ í—›ìŠ¤ìœ™ ìœ ë„ êµ¬ì¢… ì‚¬ìš© ë¹ˆë„ ì¦ê°€" : "3. ì‚¼ì§„ì´ í•„ìš”í•œ ìƒí™©ì—ì„  ì£¼ë ¥ ê²°ì •êµ¬ ì¡´ ê²½ê³„ ê³µëµ");
  el.innerHTML = points.join("<br>");
  return;
 }

 const points = [];
 points.push(metrics.nextAvg < 0.24 ? "1. ì²« íƒ€ì„ì€ ê°•í•œ ìŠ¤ìœ™ë³´ë‹¤ ì»¨íƒ ìš°ì„ ìœ¼ë¡œ íƒ€ì´ë° í™•ë³´" : "1. ì´ˆë°˜ íƒ€ì„ë¶€í„° ìœ ë¦¬ì¹´ìš´íŠ¸ ì§êµ¬ ê³µëµ ë¹„ìœ¨ ìœ ì§€");
 points.push(metrics.obp < 0.33 ? "2. ë³¼ì¹´ìš´íŠ¸ 1-0/2-1ì—ì„œ ì¶œë£¨ ì„ íƒ(ë³¼ ê³ ë¥´ê¸°) ë¹„ìœ¨ í™•ëŒ€" : "2. ì¶œë£¨ íë¦„ ìœ ì§€ë¥¼ ìœ„í•´ ë£¨ìƒ ìƒí™©ë³„ ì§„ë£¨íƒ€ ìš°ì„ ");
 points.push(metrics.slope < 0 ? "3. ìµœê·¼ í•˜ë½ì„¸ êµ¬ê°„ì´ë¯€ë¡œ íƒ€ì„ ë£¨í‹´(í˜¸í¡-ì‹œì„ -ìŠ¤íƒ€íŠ¸) ê³ ì •" : "3. í˜„ì¬ ìƒìŠ¹ì„¸ ìœ ì§€ ìœ„í•´ íƒ€ì„ ì „ ë£¨í‹´ í…œí¬ë¥¼ ë™ì¼í•˜ê²Œ ìœ ì§€");
 el.innerHTML = points.join("<br>");
}

async function analyzeBatter(dataGames, position){
 if(!dataGames || dataGames.length < 5){
  setDataInsufficient("ë°ì´í„° ë¶€ì¡± Â· íƒ€ì ë¶„ì„ ìµœì†Œ 5ê²½ê¸° í•„ìš”");
  return;
 }

 document.getElementById("pregameTitle").innerText = "PRE-GAME PREDICTION (Batter)";
 document.getElementById("scoreTitle").innerText = "BATTER SCOUT SCORE";
 document.getElementById("typeTitle").innerText = "íƒ€ì ìœ í˜• ë¶„ì„";

 const avgs = dataGames.map(g=> g.ab ? g.hits/g.ab : 0);
 const isoArr = dataGames.map(g=>{
  const singles = (g.hits||0) - (g.double||0) - (g.triple||0) - (g.hr||0);
  const tb = singles + (g.double||0)*2 + (g.triple||0)*3 + (g.hr||0)*4;
  return g.ab ? (tb/g.ab) - ((g.hits||0)/g.ab) : 0;
 });

 const inputs = avgs.map((v,i)=> [v, isoArr[i]]);
 const labels = avgs.slice(1);
 const xs = tf.tensor2d(inputs.slice(0,-1));
 const ys = tf.tensor2d(labels, [labels.length,1]);
 const modelStorageKey = `indexeddb://statdeck-model-batter-${currentSeason}`;
 const hashStorageKey = `statdeck-model-hash-batter-${currentSeason}`;

 let model;
 const currentHash = dataHash(dataGames);
 const savedHash = (await idbGet(hashStorageKey)) || localStorage.getItem(hashStorageKey);
 try{
  if(savedHash !== currentHash) throw new Error("retrain");
  model = await tf.loadLayersModel(modelStorageKey);
 }catch(e){
  model = tf.sequential();
  model.add(tf.layers.dense({units:16, activation:'relu', inputShape:[2]}));
  model.add(tf.layers.dense({units:8, activation:'relu'}));
  model.add(tf.layers.dense({units:1}));
  model.compile({optimizer:'adam', loss:'meanSquaredError'});
  const history = await model.fit(xs, ys, {epochs:80, verbose:0});
  document.getElementById('mseDisplay').innerHTML = `Model MSE: ${history.history.loss.slice(-1)[0].toFixed(6)}`;
  await model.save(modelStorageKey);
  await idbSet(hashStorageKey, currentHash);
 }

 const nextAvg = tf.tidy(()=>{
  const output = model.predict(tf.tensor2d([inputs[inputs.length-1]]));
  return output.dataSync()[0];
 });
 document.getElementById('pregame').innerHTML = `ğŸ¯ ë‹¤ìŒ ê²½ê¸° ì˜ˆìƒ íƒ€ìœ¨: <strong>${nextAvg.toFixed(3)}</strong>${position?` (${position})`:""}`;

 const xVals = avgs.map((_,i)=>i+1);
 const meanX = xVals.reduce((a,b)=>a+b)/xVals.length;
 const meanY = avgs.reduce((a,b)=>a+b)/avgs.length;
 const slope = xVals.reduce((sum,x,i)=> sum + (x-meanX)*(avgs[i]-meanY),0) / xVals.reduce((sum,x)=> sum + (x-meanX)**2,0);
 const std = Math.sqrt(avgs.map(x => (x - meanY) ** 2).reduce((a,b)=>a+b,0) / avgs.length);
 const consistency = Math.max(0, 1 - std*5);
 const obp = dataGames.reduce((s,g)=>s+((g.hits||0)+(g.bb||0)),0) / (dataGames.reduce((s,g)=>s+((g.ab||0)+(g.bb||0)+(g.hbp||0)),0) || 1);
 const score = Math.min(100, Math.max(0, Math.round((meanY*130)+(obp*100)+(nextAvg*120)+(consistency*80)+(slope*500))));
 setConfidence(dataGames.length);

 setGauge(score, score>=80 ? "â­ íƒ€ì í¼í¬ë¨¼ìŠ¤ ìš°ìˆ˜" : (score>=60 ? "ğŸ“ˆ íƒ€ì ì„±ì¥ êµ¬ê°„" : "âš ï¸ íƒ€ê²© ë³´ì™„ í•„ìš”"));
 document.getElementById('recentAnalysis').innerHTML = slope > 0 ? `ğŸ“Š ìƒìŠ¹ ê¸°ìš¸ê¸° (${slope.toFixed(4)})` : `ğŸ“‰ í•˜ë½ ê¸°ìš¸ê¸° (${slope.toFixed(4)})`;
 document.getElementById('slumpAnalysis').innerHTML = nextAvg < 0.220 ? "âš ï¸ ë‹¤ìŒ ê²½ê¸° ìŠ¬ëŸ¼í”„ ìœ„í—˜" : "âœ… íƒ€ê²© ì»¨ë””ì…˜ ì•ˆì •";

 const typeIndex = isoArr[isoArr.length-1] > 0.200 ? 0 : (nextAvg > 0.320 ? 1 : 2);
 const typeText = ["ğŸ’¥ íŒŒì›Œ íˆí„°","ğŸ¯ êµíƒ€í˜•","âš–ï¸ ë°¸ëŸ°ìŠ¤í˜•"][typeIndex];
 document.getElementById('typeAnalysis').innerHTML = `AI ì˜ˆì¸¡ ìœ í˜•: ${typeText}`;
 const priorities = [];
 if(obp < 0.33) priorities.push("ì¶œë£¨ìœ¨ ê°œì„ : ë³¼ë„·/ì‚¬êµ¬ í¬í•¨ ì¶œë£¨ë¥¼ ê²½ê¸°ë‹¹ 1íšŒ ì´ìƒ ëª©í‘œë¡œ ì„¤ì •");
 if(meanY < 0.270) priorities.push("ì»¨íƒ í’ˆì§ˆ ê°•í™”: ì´ˆêµ¬ ìŠ¤ìœ™ ì„ íƒë³´ë‹¤ ìœ ë¦¬ì¹´ìš´íŠ¸ ì „ê°œ ë¹„ìœ¨ì„ ëŠ˜ë¦¬ê¸°");
 if(slope < 0) priorities.push("í•˜ë½ ì¶”ì„¸ ëŒ€ì‘: ìµœê·¼ 3ê²½ê¸° íƒ€ê²© ë£¨í‹´(í…œí¬/ì‹œì„ ê³ ì •) ê³ ì •");
 if(std > 0.085) priorities.push("ê¸°ë³µ ì™„í™”: íƒ€ì„ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ê³ ì •í•´ ì¼ê´€ì„± í™•ë³´");
 if(nextAvg < 0.240) priorities.push("ë‹¤ìŒ ê²½ê¸° ëŒ€ë¹„: ì²« íƒ€ì„ì—ì„œ ì•ˆì • ìŠ¤ìœ™ìœ¼ë¡œ íƒ€ì´ë° ì¬ì„¤ì •");
 renderPriorities(priorities);
 renderConditionInsight(dataGames, "batter");
 renderGamePlanInsight("batter", { nextAvg, obp, slope });

 document.getElementById('modelMeta').innerHTML = `ğŸ§  batter model Â· ${dataGames.length} games`;
 xs.dispose(); ys.dispose(); model.dispose();
}

async function analyzePitcher(dataGames, pitcherType, pitchArsenal, releasePoint, throwHand){
 if(!dataGames || dataGames.length < 5){
  setDataInsufficient("ë°ì´í„° ë¶€ì¡± Â· íˆ¬ìˆ˜ ë¶„ì„ ìµœì†Œ 5ê²½ê¸° í•„ìš”");
  return;
 }

 document.getElementById("pregameTitle").innerText = "PRE-GAME PREDICTION (Pitcher)";
 document.getElementById("scoreTitle").innerText = "PITCHER SCOUT SCORE";
 document.getElementById("typeTitle").innerText = "íˆ¬ìˆ˜ ìœ í˜• ë¶„ì„";

 const eras = dataGames.map((g)=> (g.ipOuts ? ((g.er||0)*27/(g.ipOuts||1)) : 0));
 const whips = dataGames.map((g)=> (g.ipOuts ? (((g.pHits||0)+(g.pBb||0)+(g.pHbp||0))/((g.ipOuts||0)/3 || 1)) : 0));
 const kRates = dataGames.map((g)=>{
  const bf = (g.ipOuts||0)+(g.pHits||0)+(g.pBb||0)+(g.pHbp||0);
  return bf ? ((g.so||0)/bf) : 0;
 });
 const velos = dataGames.map((g)=>{
  const list = getPitchVelocities(g);
  if(!list.length) return 0;
  return list.reduce((a,b)=>a+b,0) / list.length;
 });
 const maxVelos = dataGames.map((g)=>{
  const list = getPitchMaxVelocities(g);
  if(!list.length) return 0;
  return Math.max(...list);
 });

 const inputs = eras.map((v,i)=> [v, whips[i], velos[i], maxVelos[i]]);
 const labels = eras.slice(1);
 const xs = tf.tensor2d(inputs.slice(0,-1));
 const ys = tf.tensor2d(labels, [labels.length,1]);
 const modelStorageKey = `indexeddb://statdeck-model-pitcher-${currentSeason}`;
 const hashStorageKey = `statdeck-model-hash-pitcher-${currentSeason}`;

 let model;
 const currentHash = dataHash(dataGames);
 const savedHash = (await idbGet(hashStorageKey)) || localStorage.getItem(hashStorageKey);
 try{
  if(savedHash !== currentHash) throw new Error("retrain");
  model = await tf.loadLayersModel(modelStorageKey);
 }catch(e){
  model = tf.sequential();
  model.add(tf.layers.dense({units:16, activation:'relu', inputShape:[4]}));
  model.add(tf.layers.dense({units:8, activation:'relu'}));
  model.add(tf.layers.dense({units:1}));
  model.compile({optimizer:'adam', loss:'meanSquaredError'});
  const history = await model.fit(xs, ys, {epochs:90, verbose:0});
  document.getElementById('mseDisplay').innerHTML = `Model MSE: ${history.history.loss.slice(-1)[0].toFixed(6)}`;
  await model.save(modelStorageKey);
  await idbSet(hashStorageKey, currentHash);
 }

 const nextEra = tf.tidy(()=>{
  const pred = model.predict(tf.tensor2d([inputs[inputs.length-1]]));
  return pred.dataSync()[0];
 });
 const profileTag = [pitcherType, throwHand, releasePoint].filter(Boolean).join(" Â· ");
 document.getElementById('pregame').innerHTML = `ğŸ¯ ë‹¤ìŒ ê²½ê¸° ì˜ˆìƒ ERA: <strong>${nextEra.toFixed(2)}</strong>${profileTag?` (${profileTag})`:""}`;

 const meanEra = eras.reduce((a,b)=>a+b,0)/eras.length;
 const meanWhip = whips.reduce((a,b)=>a+b,0)/whips.length;
 const meanKRate = kRates.reduce((a,b)=>a+b,0)/kRates.length;
 const veloSamples = velos.filter((v)=>v>0);
 const topVeloSamples = maxVelos.filter((v)=>v>0);
 const meanVelo = veloSamples.length ? (veloSamples.reduce((a,b)=>a+b,0)/veloSamples.length) : 0;
 const topVelo = topVeloSamples.length ? (topVeloSamples.reduce((a,b)=>a+b,0)/topVeloSamples.length) : 0;
 const eraScore = Math.max(0, 100 - (meanEra*13));
 const whipScore = Math.max(0, 100 - (meanWhip*22));
 const kScore = Math.min(100, meanKRate*250);
 const veloScore = meanVelo ? Math.min(100, Math.max(0, (meanVelo-115)*2.8)) : 50;
 const topVeloScore = topVelo ? Math.min(100, Math.max(0, (topVelo-120)*2.5)) : 50;
 const nextEraBonus = Math.max(0, 100 - (nextEra*14));
 const score = Math.max(0, Math.min(100, Math.round((eraScore*0.27)+(whipScore*0.22)+(kScore*0.17)+(nextEraBonus*0.18)+(veloScore*0.08)+(topVeloScore*0.08))));
 setConfidence(dataGames.length);

 setGauge(score, score>=80 ? "ğŸ”¥ íˆ¬ìˆ˜ í¼í¬ë¨¼ìŠ¤ ìš°ìˆ˜" : (score>=60 ? "ğŸ“ˆ íˆ¬ìˆ˜ ì„±ì¥ êµ¬ê°„" : "âš ï¸ íˆ¬ìˆ˜ ë³´ì™„ í•„ìš”"));
 document.getElementById('recentAnalysis').innerHTML = `ìµœê·¼ í‰ê·  ERA ${meanEra.toFixed(2)} Â· WHIP ${meanWhip.toFixed(2)}${meanVelo ? ` Â· í‰ê· êµ¬ì† ${meanVelo.toFixed(1)}` : ""}${topVelo ? ` Â· ìµœê³ êµ¬ì† ${topVelo.toFixed(1)}` : ""}`;
 document.getElementById('slumpAnalysis').innerHTML = nextEra > 4.50 ? "âš ï¸ ë‹¤ìŒ ê²½ê¸° ë‚œì¡° ìœ„í—˜" : "âœ… ì»¨ë””ì…˜ ì•ˆì •";
 const typeText = (meanVelo >= 138 || meanKRate >= 0.26) ? "ğŸ’¥ íŒŒì›Œ í”¼ì²˜" : (meanWhip <= 1.25 ? "ğŸ¯ ì œêµ¬í˜•" : "âš–ï¸ ë°¸ëŸ°ìŠ¤í˜•");
 const arsenalText = (pitchArsenal || []).length ? ` Â· êµ¬ì¢… ${pitchArsenal.join("/")}` : "";
 document.getElementById('typeAnalysis').innerHTML = `AI ì˜ˆì¸¡ ìœ í˜•: ${typeText}${arsenalText}`;
 const walksPerGame = dataGames.reduce((s,g)=>s + (g.pBb || 0) + (g.pHbp || 0), 0) / dataGames.length;
 const priorities = [];
 if(meanEra > 4.50) priorities.push("ì‹¤ì  ì–µì œ ìš°ì„ : ì´ˆë°˜ ì´ë‹ ì„ ë‘íƒ€ì ì¶œë£¨ ê´€ë¦¬ ê°•í™”");
 if(meanWhip > 1.45) priorities.push("ì£¼ì ê´€ë¦¬ ê°œì„ : ë³¼ë„·Â·ì‚¬êµ¬ í—ˆìš©ì„ ê²½ê¸°ë‹¹ 2ê°œ ì´í•˜ë¡œ ì œí•œ");
 if(meanKRate < 0.18) priorities.push("ê²°ì •êµ¬ ë¹„ìœ¨ ì¡°ì •: ìœ ë¦¬ì¹´ìš´íŠ¸ì—ì„œ ì‚¼ì§„ ìœ ë„ íŒ¨í„´ ê°•í™”");
 if(walksPerGame > 2.2) priorities.push("ì œêµ¬ ì•ˆì •í™”: ì¢Œìš° ì½”ë„ˆ ëª©í‘œêµ¬ì—­ ë£¨í‹´ ê³ ì •");
 if(nextEra > 4.50) priorities.push("ë‹¤ìŒ ê²½ê¸° ëŒ€ë¹„: ì´ˆêµ¬ ìŠ¤íŠ¸ë¼ì´í¬ ë¹„ìœ¨ì„ ìš°ì„  ëª©í‘œë¡œ ì„¤ì •");
 renderPriorities(priorities);
 renderConditionInsight(dataGames, "pitcher");
 renderGamePlanInsight("pitcher", { nextEra, meanWhip, meanKRate });
 document.getElementById('modelMeta').innerHTML = `ğŸ§  pitcher model Â· ${dataGames.length} games${throwHand ? ` Â· ${throwHand}` : ""}${releasePoint ? ` Â· ${releasePoint}` : ""}`;
 xs.dispose(); ys.dispose(); model.dispose();
}

async function analyze(){
 const profileData = (await idbGet("profileData")) || JSON.parse(localStorage.getItem("profileData") || "{}");
 const params = new URLSearchParams(location.search);
 const role = params.get("role") || profileData.role || "batter";
 const position = params.get("position") || profileData.position || "";
 const pitcherType = params.get("pitcherType") || profileData.pitcherType || "";
 const pitchArsenalParam = params.get("pitchArsenal");
 const pitchArsenal = pitchArsenalParam ? pitchArsenalParam.split(",").filter(Boolean) : (Array.isArray(profileData.pitchArsenal) ? profileData.pitchArsenal : []);
 const releasePoint = params.get("releasePoint") || profileData.releasePoint || "";
 const throwHand = params.get("throwHand") || profileData.throwHand || "";
 const roleGames = games.filter((g)=>(g.role || "batter") === role);
 const targetGames = roleGames.length ? roleGames : games;
 if(role === "pitcher"){
  await analyzePitcher(targetGames, pitcherType, pitchArsenal, releasePoint, throwHand);
 }else{
  await analyzeBatter(targetGames, position);
 }
}

async function initializeAnalytics(){
 seasonData = (await idbGet("seasonData")) || JSON.parse(localStorage.getItem("seasonData") || "{}");
 const lastSeason = (await idbGet("lastSeasonKey")) || localStorage.getItem("lastSeasonKey");
 currentSeason = resolveSeasonKey(lastSeason);
 if(!currentSeason){
  setDataInsufficient("ë°ì´í„° ì—†ìŒ");
  return;
 }
 games = seasonData[currentSeason] || [];
 analyze();
}

initializeAnalytics();

</script>

</body>
</html>
